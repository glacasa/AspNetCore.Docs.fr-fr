---
title: Session dans ASP.NET Core
author: rick-anderson
description: Découvrez les approches permettant de préserver la session entre les demandes.
ms.author: riande
ms.custom: mvc
ms.date: 03/06/2020
no-loc:
- ASP.NET Core Identity
- cookie
- Cookie
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: fundamentals/app-state
ms.openlocfilehash: 95035ec372ab6adb5bafb40f2b939c549ac6f839
ms.sourcegitcommit: 65add17f74a29a647d812b04517e46cbc78258f9
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/19/2020
ms.locfileid: "88633810"
---
# <a name="session-and-state-management-in-aspnet-core"></a><span data-ttu-id="d3cce-103">Gestion de session et d’état dans ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="d3cce-103">Session and state management in ASP.NET Core</span></span>

::: moniker range=">= aspnetcore-3.0"

<span data-ttu-id="d3cce-104">Par [Rick Anderson](https://twitter.com/RickAndMSFT), [Kirk Larkin](https://twitter.com/serpent5)et [Diana Larose](https://github.com/DianaLaRose)</span><span class="sxs-lookup"><span data-stu-id="d3cce-104">By [Rick Anderson](https://twitter.com/RickAndMSFT), [Kirk Larkin](https://twitter.com/serpent5), and [Diana LaRose](https://github.com/DianaLaRose)</span></span>

<span data-ttu-id="d3cce-105">HTTP est un protocole sans état.</span><span class="sxs-lookup"><span data-stu-id="d3cce-105">HTTP is a stateless protocol.</span></span> <span data-ttu-id="d3cce-106">Par défaut, les requêtes HTTP sont des messages indépendants qui ne conservent pas les valeurs utilisateur.</span><span class="sxs-lookup"><span data-stu-id="d3cce-106">By default, HTTP requests are independent messages that don't retain user values.</span></span> <span data-ttu-id="d3cce-107">Cet article décrit plusieurs approches permettant de conserver les données utilisateur entre les demandes.</span><span class="sxs-lookup"><span data-stu-id="d3cce-107">This article describes several approaches to preserve user data between requests.</span></span>

<span data-ttu-id="d3cce-108">[Afficher ou télécharger l’exemple de code](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/fundamentals/app-state/samples) ([procédure de téléchargement](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="d3cce-108">[View or download sample code](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/fundamentals/app-state/samples) ([how to download](xref:index#how-to-download-a-sample))</span></span>

## <a name="state-management"></a><span data-ttu-id="d3cce-109">Gestion de l'état</span><span class="sxs-lookup"><span data-stu-id="d3cce-109">State management</span></span>

<span data-ttu-id="d3cce-110">L’état peut être stocké à l’aide de plusieurs approches.</span><span class="sxs-lookup"><span data-stu-id="d3cce-110">State can be stored using several approaches.</span></span> <span data-ttu-id="d3cce-111">Chacune d’elles est abordée plus loin dans cette rubrique.</span><span class="sxs-lookup"><span data-stu-id="d3cce-111">Each approach is described later in this topic.</span></span>

| <span data-ttu-id="d3cce-112">Approche du stockage</span><span class="sxs-lookup"><span data-stu-id="d3cce-112">Storage approach</span></span> | <span data-ttu-id="d3cce-113">Mécanisme de stockage</span><span class="sxs-lookup"><span data-stu-id="d3cce-113">Storage mechanism</span></span> |
| ---------------- | ----------------- |
| <span data-ttu-id="d3cce-114">[Cookiex](#cookies)</span><span class="sxs-lookup"><span data-stu-id="d3cce-114">[Cookies](#cookies)</span></span> | <span data-ttu-id="d3cce-115">HTTP cookie s.</span><span class="sxs-lookup"><span data-stu-id="d3cce-115">HTTP cookies.</span></span> <span data-ttu-id="d3cce-116">Peut inclure des données stockées à l’aide du code d’application côté serveur.</span><span class="sxs-lookup"><span data-stu-id="d3cce-116">May include data stored using server-side app code.</span></span> |
| [<span data-ttu-id="d3cce-117">État de session</span><span class="sxs-lookup"><span data-stu-id="d3cce-117">Session state</span></span>](#session-state) | <span data-ttu-id="d3cce-118">HTTP cookie s et code d’application côté serveur</span><span class="sxs-lookup"><span data-stu-id="d3cce-118">HTTP cookies and server-side app code</span></span> |
| [<span data-ttu-id="d3cce-119">TempData</span><span class="sxs-lookup"><span data-stu-id="d3cce-119">TempData</span></span>](#tempdata) | <span data-ttu-id="d3cce-120">HTTP cookie s ou état de session</span><span class="sxs-lookup"><span data-stu-id="d3cce-120">HTTP cookies or session state</span></span> |
| [<span data-ttu-id="d3cce-121">Chaînes de requête</span><span class="sxs-lookup"><span data-stu-id="d3cce-121">Query strings</span></span>](#query-strings) | <span data-ttu-id="d3cce-122">Chaînes de requête HTTP</span><span class="sxs-lookup"><span data-stu-id="d3cce-122">HTTP query strings</span></span> |
| [<span data-ttu-id="d3cce-123">Champs masqués</span><span class="sxs-lookup"><span data-stu-id="d3cce-123">Hidden fields</span></span>](#hidden-fields) | <span data-ttu-id="d3cce-124">Champs de formulaires HTTP</span><span class="sxs-lookup"><span data-stu-id="d3cce-124">HTTP form fields</span></span> |
| [<span data-ttu-id="d3cce-125">HttpContext.Items</span><span class="sxs-lookup"><span data-stu-id="d3cce-125">HttpContext.Items</span></span>](#httpcontextitems) | <span data-ttu-id="d3cce-126">Code d’application côté serveur</span><span class="sxs-lookup"><span data-stu-id="d3cce-126">Server-side app code</span></span> |
| [<span data-ttu-id="d3cce-127">Cache</span><span class="sxs-lookup"><span data-stu-id="d3cce-127">Cache</span></span>](#cache) | <span data-ttu-id="d3cce-128">Code d’application côté serveur</span><span class="sxs-lookup"><span data-stu-id="d3cce-128">Server-side app code</span></span> |

## <a name="no-loccookies"></a><span data-ttu-id="d3cce-129">Cookies</span><span class="sxs-lookup"><span data-stu-id="d3cce-129">Cookies</span></span>

<span data-ttu-id="d3cce-130">Cookiestocke les données entre les demandes.</span><span class="sxs-lookup"><span data-stu-id="d3cce-130">Cookies store data across requests.</span></span> <span data-ttu-id="d3cce-131">Étant donné que les cookie sont envoyés avec chaque demande, leur taille doit être réduite à un minimum.</span><span class="sxs-lookup"><span data-stu-id="d3cce-131">Because cookies are sent with every request, their size should be kept to a minimum.</span></span> <span data-ttu-id="d3cce-132">Dans l’idéal, seul un identificateur doit être stocké dans un cookie avec les données stockées par l’application.</span><span class="sxs-lookup"><span data-stu-id="d3cce-132">Ideally, only an identifier should be stored in a cookie with the data stored by the app.</span></span> <span data-ttu-id="d3cce-133">La plupart des navigateurs limitent la cookie taille à 4096 octets.</span><span class="sxs-lookup"><span data-stu-id="d3cce-133">Most browsers restrict cookie size to 4096 bytes.</span></span> <span data-ttu-id="d3cce-134">Seul un nombre limité de cookie s est disponible pour chaque domaine.</span><span class="sxs-lookup"><span data-stu-id="d3cce-134">Only a limited number of cookies are available for each domain.</span></span>

<span data-ttu-id="d3cce-135">Étant donné que cookie les s sont sujettes à falsification, elles doivent être validées par l’application.</span><span class="sxs-lookup"><span data-stu-id="d3cce-135">Because cookies are subject to tampering, they must be validated by the app.</span></span> <span data-ttu-id="d3cce-136">Cookiepeuvent être supprimés par les utilisateurs et expirent sur les clients.</span><span class="sxs-lookup"><span data-stu-id="d3cce-136">Cookies can be deleted by users and expire on clients.</span></span> <span data-ttu-id="d3cce-137">Toutefois, cookie les s sont généralement la forme la plus durable de la persistance des données sur le client.</span><span class="sxs-lookup"><span data-stu-id="d3cce-137">However, cookies are generally the most durable form of data persistence on the client.</span></span>

<span data-ttu-id="d3cce-138">Cookieles s sont souvent utilisées pour la personnalisation, où le contenu est personnalisé pour un utilisateur connu.</span><span class="sxs-lookup"><span data-stu-id="d3cce-138">Cookies are often used for personalization, where content is customized for a known user.</span></span> <span data-ttu-id="d3cce-139">L’utilisateur est uniquement identifié, et pas authentifié dans la plupart des cas.</span><span class="sxs-lookup"><span data-stu-id="d3cce-139">The user is only identified and not authenticated in most cases.</span></span> <span data-ttu-id="d3cce-140">Le cookie peut stocker le nom de l’utilisateur, le nom du compte ou un ID d’utilisateur unique, tel qu’un GUID.</span><span class="sxs-lookup"><span data-stu-id="d3cce-140">The cookie can store the user's name, account name, or unique user ID such as a GUID.</span></span> <span data-ttu-id="d3cce-141">Le cookie peut être utilisé pour accéder aux paramètres personnalisés de l’utilisateur, tels que la couleur d’arrière-plan de votre site Web préféré.</span><span class="sxs-lookup"><span data-stu-id="d3cce-141">The cookie can be used to access the user's personalized settings, such as their preferred website background color.</span></span>

<span data-ttu-id="d3cce-142">Consultez les [RGPD (General Data Protection Regulations) de l’Union européenne](https://ec.europa.eu/info/law/law-topic/data-protection) lors de l’émission cookie et du traitement des problèmes de confidentialité.</span><span class="sxs-lookup"><span data-stu-id="d3cce-142">See the [European Union General Data Protection Regulations (GDPR)](https://ec.europa.eu/info/law/law-topic/data-protection) when issuing cookies and dealing with privacy concerns.</span></span> <span data-ttu-id="d3cce-143">Pour plus d’informations, consultez [Prise en charge du règlement général sur la protection des données (RGPD) de l’Union Européenne dans ASP.NET Core](xref:security/gdpr).</span><span class="sxs-lookup"><span data-stu-id="d3cce-143">For more information, see [General Data Protection Regulation (GDPR) support in ASP.NET Core](xref:security/gdpr).</span></span>

## <a name="session-state"></a><span data-ttu-id="d3cce-144">État de la session</span><span class="sxs-lookup"><span data-stu-id="d3cce-144">Session state</span></span>

<span data-ttu-id="d3cce-145">L’état de session est un scénario ASP.NET Core pour le stockage des données utilisateur pendant que l’utilisateur parcourt une application web.</span><span class="sxs-lookup"><span data-stu-id="d3cce-145">Session state is an ASP.NET Core scenario for storage of user data while the user browses a web app.</span></span> <span data-ttu-id="d3cce-146">L’état de session utilise un magasin tenu à jour par l’application afin de conserver les données entre les requêtes d’un client.</span><span class="sxs-lookup"><span data-stu-id="d3cce-146">Session state uses a store maintained by the app to persist data across requests from a client.</span></span> <span data-ttu-id="d3cce-147">Les données de session sont soutenus par un cache et considérées comme des données éphémères.</span><span class="sxs-lookup"><span data-stu-id="d3cce-147">The session data is backed by a cache and considered ephemeral data.</span></span> <span data-ttu-id="d3cce-148">Le site doit continuer à fonctionner sans les données de session.</span><span class="sxs-lookup"><span data-stu-id="d3cce-148">The site should continue to function without the session data.</span></span> <span data-ttu-id="d3cce-149">Les données d’application critiques doivent être stockées dans la base de données utilisateur et mises en cache dans la session uniquement à des fins d’optimisation des performances.</span><span class="sxs-lookup"><span data-stu-id="d3cce-149">Critical application data should be stored in the user database and cached in session only as a performance optimization.</span></span>

<span data-ttu-id="d3cce-150">La session n’est pas prise en charge dans les [SignalR](xref:signalr/index) applications, car un [ SignalR Hub](xref:signalr/hubs) peut s’exécuter indépendamment d’un contexte http.</span><span class="sxs-lookup"><span data-stu-id="d3cce-150">Session isn't supported in [SignalR](xref:signalr/index) apps because a [SignalR Hub](xref:signalr/hubs) may execute independent of an HTTP context.</span></span> <span data-ttu-id="d3cce-151">Par exemple, cela peut se produire quand une longue requête d’interrogation est ouverte par un hub au-delà de la durée de vie du contexte de la requête HTTP.</span><span class="sxs-lookup"><span data-stu-id="d3cce-151">For example, this can occur when a long polling request is held open by a hub beyond the lifetime of the request's HTTP context.</span></span>

<span data-ttu-id="d3cce-152">ASP.NET Core conserve l’état de session en fournissant un cookie au client qui contient un ID de session.</span><span class="sxs-lookup"><span data-stu-id="d3cce-152">ASP.NET Core maintains session state by providing a cookie to the client that contains a session ID.</span></span> <span data-ttu-id="d3cce-153">cookieID de session :</span><span class="sxs-lookup"><span data-stu-id="d3cce-153">The cookie session ID:</span></span>

* <span data-ttu-id="d3cce-154">Est envoyé à l’application avec chaque demande.</span><span class="sxs-lookup"><span data-stu-id="d3cce-154">Is sent to the app with each request.</span></span>
* <span data-ttu-id="d3cce-155">Est utilisé par l’application pour extraire les données de session.</span><span class="sxs-lookup"><span data-stu-id="d3cce-155">Is used by the app to fetch the session data.</span></span>

<span data-ttu-id="d3cce-156">L’état de session présente les comportements suivants :</span><span class="sxs-lookup"><span data-stu-id="d3cce-156">Session state exhibits the following behaviors:</span></span>

* <span data-ttu-id="d3cce-157">La session cookie est spécifique au navigateur.</span><span class="sxs-lookup"><span data-stu-id="d3cce-157">The session cookie is specific to the browser.</span></span> <span data-ttu-id="d3cce-158">Les sessions ne sont pas partagées entre les navigateurs.</span><span class="sxs-lookup"><span data-stu-id="d3cce-158">Sessions aren't shared across browsers.</span></span>
* <span data-ttu-id="d3cce-159">cookieLes sessions sont supprimées à la fin de la session du navigateur.</span><span class="sxs-lookup"><span data-stu-id="d3cce-159">Session cookies are deleted when the browser session ends.</span></span>
* <span data-ttu-id="d3cce-160">Si une cookie est reçue pour une session ayant expiré, une nouvelle session qui utilise la même session est créée cookie .</span><span class="sxs-lookup"><span data-stu-id="d3cce-160">If a cookie is received for an expired session, a new session is created that uses the same session cookie.</span></span>
* <span data-ttu-id="d3cce-161">Les sessions vides ne sont pas conservées.</span><span class="sxs-lookup"><span data-stu-id="d3cce-161">Empty sessions aren't retained.</span></span> <span data-ttu-id="d3cce-162">La session doit avoir au moins une valeur définie pour conserver la session entre les demandes.</span><span class="sxs-lookup"><span data-stu-id="d3cce-162">The session must have at least one value set to persist the session across requests.</span></span> <span data-ttu-id="d3cce-163">Quand une session n’est pas conservée, un nouvel ID de session est généré pour chaque nouvelle requête.</span><span class="sxs-lookup"><span data-stu-id="d3cce-163">When a session isn't retained, a new session ID is generated for each new request.</span></span>
* <span data-ttu-id="d3cce-164">L’application conserve une session pendant une période limitée après la dernière requête.</span><span class="sxs-lookup"><span data-stu-id="d3cce-164">The app retains a session for a limited time after the last request.</span></span> <span data-ttu-id="d3cce-165">L’application définit le délai d’expiration d’une session ou utilise la valeur par défaut de 20 minutes.</span><span class="sxs-lookup"><span data-stu-id="d3cce-165">The app either sets the session timeout or uses the default value of 20 minutes.</span></span> <span data-ttu-id="d3cce-166">L’état de session est idéal pour le stockage des données utilisateur :</span><span class="sxs-lookup"><span data-stu-id="d3cce-166">Session state is ideal for storing user data:</span></span>
  * <span data-ttu-id="d3cce-167">Cela est spécifique à une session particulière.</span><span class="sxs-lookup"><span data-stu-id="d3cce-167">That's specific to a particular session.</span></span>
  * <span data-ttu-id="d3cce-168">Où les données ne nécessitent pas de stockage permanent entre les sessions.</span><span class="sxs-lookup"><span data-stu-id="d3cce-168">Where the data doesn't require permanent storage across sessions.</span></span>
* <span data-ttu-id="d3cce-169">Les données de session sont supprimées lorsque l' <xref:Microsoft.AspNetCore.Http.ISession.Clear%2A?displayProperty=nameWithType> implémentation est appelée ou lorsque la session expire.</span><span class="sxs-lookup"><span data-stu-id="d3cce-169">Session data is deleted either when the <xref:Microsoft.AspNetCore.Http.ISession.Clear%2A?displayProperty=nameWithType> implementation is called or when the session expires.</span></span>
* <span data-ttu-id="d3cce-170">Il n’existe pas de mécanisme par défaut pour informer le code de l’application qu’un navigateur client a été fermé ou lorsque la session cookie est supprimée ou a expiré sur le client.</span><span class="sxs-lookup"><span data-stu-id="d3cce-170">There's no default mechanism to inform app code that a client browser has been closed or when the session cookie is deleted or expired on the client.</span></span>
* <span data-ttu-id="d3cce-171">Les États cookie de session s ne sont pas marqués comme essentiels par défaut.</span><span class="sxs-lookup"><span data-stu-id="d3cce-171">Session state cookies aren't marked essential by default.</span></span> <span data-ttu-id="d3cce-172">L’état de session n’est pas fonctionnel, sauf si le suivi est autorisé par le visiteur du site.</span><span class="sxs-lookup"><span data-stu-id="d3cce-172">Session state isn't functional unless tracking is permitted by the site visitor.</span></span> <span data-ttu-id="d3cce-173">Pour plus d'informations, consultez <xref:security/gdpr#tempdata-provider-and-session-state-cookies-arent-essential>.</span><span class="sxs-lookup"><span data-stu-id="d3cce-173">For more information, see <xref:security/gdpr#tempdata-provider-and-session-state-cookies-arent-essential>.</span></span>

> [!WARNING]
> <span data-ttu-id="d3cce-174">Ne stockez pas de données sensibles dans l’état de session.</span><span class="sxs-lookup"><span data-stu-id="d3cce-174">Don't store sensitive data in session state.</span></span> <span data-ttu-id="d3cce-175">Il se peut que l’utilisateur ne ferme pas le navigateur et n’efface pas la session cookie .</span><span class="sxs-lookup"><span data-stu-id="d3cce-175">The user might not close the browser and clear the session cookie.</span></span> <span data-ttu-id="d3cce-176">Certains navigateurs maintiennent des sessions valides cookie entre les fenêtres de navigateur.</span><span class="sxs-lookup"><span data-stu-id="d3cce-176">Some browsers maintain valid session cookies across browser windows.</span></span> <span data-ttu-id="d3cce-177">Une session peut ne pas être restreinte à un seul utilisateur.</span><span class="sxs-lookup"><span data-stu-id="d3cce-177">A session might not be restricted to a single user.</span></span> <span data-ttu-id="d3cce-178">L’utilisateur suivant peut continuer à parcourir l’application avec la même session cookie .</span><span class="sxs-lookup"><span data-stu-id="d3cce-178">The next user might continue to browse the app with the same session cookie.</span></span>

<span data-ttu-id="d3cce-179">Le fournisseur de cache en mémoire stocke les données de session dans la mémoire du serveur où réside l’application.</span><span class="sxs-lookup"><span data-stu-id="d3cce-179">The in-memory cache provider stores session data in the memory of the server where the app resides.</span></span> <span data-ttu-id="d3cce-180">Dans un scénario de batterie de serveurs :</span><span class="sxs-lookup"><span data-stu-id="d3cce-180">In a server farm scenario:</span></span>

* <span data-ttu-id="d3cce-181">Utilisez des *sessions persistantes* pour lier chaque session à une instance d’application spécifique sur un serveur donné.</span><span class="sxs-lookup"><span data-stu-id="d3cce-181">Use *sticky sessions* to tie each session to a specific app instance on an individual server.</span></span> <span data-ttu-id="d3cce-182">[Azure App Service](https://azure.microsoft.com/services/app-service/) utilise [Application Request Routing (ARR)](/iis/extensions/planning-for-arr/using-the-application-request-routing-module) pour appliquer les sessions persistantes par défaut.</span><span class="sxs-lookup"><span data-stu-id="d3cce-182">[Azure App Service](https://azure.microsoft.com/services/app-service/) uses [Application Request Routing (ARR)](/iis/extensions/planning-for-arr/using-the-application-request-routing-module) to enforce sticky sessions by default.</span></span> <span data-ttu-id="d3cce-183">Toutefois, les sessions rémanentes peuvent impacter l’extensibilité et compliquer les mises à jour des applications web.</span><span class="sxs-lookup"><span data-stu-id="d3cce-183">However, sticky sessions can affect scalability and complicate web app updates.</span></span> <span data-ttu-id="d3cce-184">Une meilleure approche consiste à utiliser le cache distribué Redis ou SQL Server, qui ne nécessite pas de sessions persistantes.</span><span class="sxs-lookup"><span data-stu-id="d3cce-184">A better approach is to use a Redis or SQL Server distributed cache, which doesn't require sticky sessions.</span></span> <span data-ttu-id="d3cce-185">Pour plus d'informations, consultez <xref:performance/caching/distributed>.</span><span class="sxs-lookup"><span data-stu-id="d3cce-185">For more information, see <xref:performance/caching/distributed>.</span></span>
* <span data-ttu-id="d3cce-186">La session cookie est chiffrée via <xref:Microsoft.AspNetCore.DataProtection.IDataProtector> .</span><span class="sxs-lookup"><span data-stu-id="d3cce-186">The session cookie is encrypted via <xref:Microsoft.AspNetCore.DataProtection.IDataProtector>.</span></span> <span data-ttu-id="d3cce-187">La protection des données doit être correctement configurée pour lire cookie les sessions sur chaque ordinateur.</span><span class="sxs-lookup"><span data-stu-id="d3cce-187">Data Protection must be properly configured to read session cookies on each machine.</span></span> <span data-ttu-id="d3cce-188">Pour plus d’informations, consultez <xref:security/data-protection/introduction> et [Fournisseurs de stockage de clés](xref:security/data-protection/implementation/key-storage-providers).</span><span class="sxs-lookup"><span data-stu-id="d3cce-188">For more information, see <xref:security/data-protection/introduction> and [Key storage providers](xref:security/data-protection/implementation/key-storage-providers).</span></span>

### <a name="configure-session-state"></a><span data-ttu-id="d3cce-189">Configurer l’état de session</span><span class="sxs-lookup"><span data-stu-id="d3cce-189">Configure session state</span></span>

<span data-ttu-id="d3cce-190">Le package [Microsoft. AspNetCore. session](https://www.nuget.org/packages/Microsoft.AspNetCore.Session/) :</span><span class="sxs-lookup"><span data-stu-id="d3cce-190">The [Microsoft.AspNetCore.Session](https://www.nuget.org/packages/Microsoft.AspNetCore.Session/) package:</span></span>

* <span data-ttu-id="d3cce-191">Est inclus implicitement par le Framework.</span><span class="sxs-lookup"><span data-stu-id="d3cce-191">Is included implicitly by the framework.</span></span>
* <span data-ttu-id="d3cce-192">Fournit un intergiciel (middleware) pour gérer l’état de session.</span><span class="sxs-lookup"><span data-stu-id="d3cce-192">Provides middleware for managing session state.</span></span>

<span data-ttu-id="d3cce-193">Pour activer le middleware Session, `Startup` doit contenir les éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="d3cce-193">To enable the session middleware, `Startup` must contain:</span></span>

* <span data-ttu-id="d3cce-194">L’un des <xref:Microsoft.Extensions.Caching.Distributed.IDistributedCache> caches de mémoire.</span><span class="sxs-lookup"><span data-stu-id="d3cce-194">Any of the <xref:Microsoft.Extensions.Caching.Distributed.IDistributedCache> memory caches.</span></span> <span data-ttu-id="d3cce-195">L’implémentation `IDistributedCache` est utilisée comme magasin de stockage pour la session.</span><span class="sxs-lookup"><span data-stu-id="d3cce-195">The `IDistributedCache` implementation is used as a backing store for session.</span></span> <span data-ttu-id="d3cce-196">Pour plus d'informations, consultez <xref:performance/caching/distributed>.</span><span class="sxs-lookup"><span data-stu-id="d3cce-196">For more information, see <xref:performance/caching/distributed>.</span></span>
* <span data-ttu-id="d3cce-197">Appel à <xref:Microsoft.Extensions.DependencyInjection.SessionServiceCollectionExtensions.AddSession%2A> dans `ConfigureServices` .</span><span class="sxs-lookup"><span data-stu-id="d3cce-197">A call to <xref:Microsoft.Extensions.DependencyInjection.SessionServiceCollectionExtensions.AddSession%2A> in `ConfigureServices`.</span></span>
* <span data-ttu-id="d3cce-198">Appel à <xref:Microsoft.AspNetCore.Builder.SessionMiddlewareExtensions.UseSession%2A> dans `Configure` .</span><span class="sxs-lookup"><span data-stu-id="d3cce-198">A call to <xref:Microsoft.AspNetCore.Builder.SessionMiddlewareExtensions.UseSession%2A> in `Configure`.</span></span>

<span data-ttu-id="d3cce-199">Le code suivant montre comment configurer le fournisseur de session en mémoire avec une implémentation en mémoire par défaut de `IDistributedCache` :</span><span class="sxs-lookup"><span data-stu-id="d3cce-199">The following code shows how to set up the in-memory session provider with a default in-memory implementation of `IDistributedCache`:</span></span>

[!code-csharp[](app-state/samples/3.x/SessionSample/Startup4.cs?name=snippet1&highlight=12-19,45)]

<span data-ttu-id="d3cce-200">Le code précédent définit un délai d’expiration réduit pour simplifier les tests.</span><span class="sxs-lookup"><span data-stu-id="d3cce-200">The preceding code sets a short timeout to simplify testing.</span></span>

<span data-ttu-id="d3cce-201">L’ordre des middlewares est important.</span><span class="sxs-lookup"><span data-stu-id="d3cce-201">The order of middleware is important.</span></span>  <span data-ttu-id="d3cce-202">Appelez `UseSession` après `UseRouting` et avant `UseEndpoints` .</span><span class="sxs-lookup"><span data-stu-id="d3cce-202">Call `UseSession` after `UseRouting` and before `UseEndpoints`.</span></span> <span data-ttu-id="d3cce-203">Consultez [classement des intergiciels (middleware](xref:fundamentals/middleware/index#order)).</span><span class="sxs-lookup"><span data-stu-id="d3cce-203">See [Middleware Ordering](xref:fundamentals/middleware/index#order).</span></span>

<span data-ttu-id="d3cce-204">[HttpContext.Session](xref:Microsoft.AspNetCore.Http.HttpContext.Session) est disponible une fois l’état de session configuré.</span><span class="sxs-lookup"><span data-stu-id="d3cce-204">[HttpContext.Session](xref:Microsoft.AspNetCore.Http.HttpContext.Session) is available after session state is configured.</span></span>

<span data-ttu-id="d3cce-205">`HttpContext.Session` n’est pas accessible avant que `UseSession` ait été appelée.</span><span class="sxs-lookup"><span data-stu-id="d3cce-205">`HttpContext.Session` can't be accessed before `UseSession` has been called.</span></span>

<span data-ttu-id="d3cce-206">Une nouvelle session avec une nouvelle session cookie ne peut pas être créée après que l’application a commencé l’écriture dans le flux de réponse.</span><span class="sxs-lookup"><span data-stu-id="d3cce-206">A new session with a new session cookie can't be created after the app has begun writing to the response stream.</span></span> <span data-ttu-id="d3cce-207">L’exception est enregistrée dans le journal de serveur web et n’est pas affichée pas dans le navigateur.</span><span class="sxs-lookup"><span data-stu-id="d3cce-207">The exception is recorded in the web server log and not displayed in the browser.</span></span>

### <a name="load-session-state-asynchronously"></a><span data-ttu-id="d3cce-208">Charger l’état de session de façon asynchrone</span><span class="sxs-lookup"><span data-stu-id="d3cce-208">Load session state asynchronously</span></span>

<span data-ttu-id="d3cce-209">Dans ASP.NET Core, le fournisseur de session par défaut charge les enregistrements de session à partir du magasin de stockage sous-jacent de <xref:Microsoft.Extensions.Caching.Distributed.IDistributedCache> façon asynchrone uniquement si la <xref:Microsoft.AspNetCore.Http.ISession.LoadAsync%2A?displayProperty=nameWithType> méthode est appelée explicitement avant les <xref:Microsoft.AspNetCore.Http.ISession.TryGetValue%2A> <xref:Microsoft.AspNetCore.Http.ISession.Set%2A> méthodes, ou <xref:Microsoft.AspNetCore.Http.ISession.Remove%2A> .</span><span class="sxs-lookup"><span data-stu-id="d3cce-209">The default session provider in ASP.NET Core loads session records from the underlying <xref:Microsoft.Extensions.Caching.Distributed.IDistributedCache> backing store asynchronously only if the <xref:Microsoft.AspNetCore.Http.ISession.LoadAsync%2A?displayProperty=nameWithType> method is explicitly called before the <xref:Microsoft.AspNetCore.Http.ISession.TryGetValue%2A>, <xref:Microsoft.AspNetCore.Http.ISession.Set%2A>, or <xref:Microsoft.AspNetCore.Http.ISession.Remove%2A> methods.</span></span> <span data-ttu-id="d3cce-210">Si `LoadAsync` n’est pas appelée en premier, l’enregistrement de session sous-jacent est chargé de façon synchrone, ce qui peut entraîner une baisse des performances à l’échelle.</span><span class="sxs-lookup"><span data-stu-id="d3cce-210">If `LoadAsync` isn't called first, the underlying session record is loaded synchronously, which can incur a performance penalty at scale.</span></span>

<span data-ttu-id="d3cce-211">Pour que les applications appliquent ce modèle, encapsulez les <xref:Microsoft.AspNetCore.Session.DistributedSessionStore> <xref:Microsoft.AspNetCore.Session.DistributedSession> implémentations et avec des versions qui lèvent une exception si la `LoadAsync` méthode n’est pas appelée avant `TryGetValue` , `Set` ou `Remove` .</span><span class="sxs-lookup"><span data-stu-id="d3cce-211">To have apps enforce this pattern, wrap the <xref:Microsoft.AspNetCore.Session.DistributedSessionStore> and <xref:Microsoft.AspNetCore.Session.DistributedSession> implementations with versions that throw an exception if the `LoadAsync` method isn't called before `TryGetValue`, `Set`, or `Remove`.</span></span> <span data-ttu-id="d3cce-212">Inscrivez ensuite les versions incluses dans le wrapper auprès du conteneur de services.</span><span class="sxs-lookup"><span data-stu-id="d3cce-212">Register the wrapped versions in the services container.</span></span>

### <a name="session-options"></a><span data-ttu-id="d3cce-213">Options de session</span><span class="sxs-lookup"><span data-stu-id="d3cce-213">Session options</span></span>

<span data-ttu-id="d3cce-214">Pour remplacer les valeurs par défaut de la session, utilisez <xref:Microsoft.AspNetCore.Builder.SessionOptions> .</span><span class="sxs-lookup"><span data-stu-id="d3cce-214">To override session defaults, use <xref:Microsoft.AspNetCore.Builder.SessionOptions>.</span></span>

| <span data-ttu-id="d3cce-215">Option</span><span class="sxs-lookup"><span data-stu-id="d3cce-215">Option</span></span> | <span data-ttu-id="d3cce-216">Description</span><span class="sxs-lookup"><span data-stu-id="d3cce-216">Description</span></span> |
| ------ | ----------- |
| <xref:Microsoft.AspNetCore.Builder.SessionOptions.Cookie> | <span data-ttu-id="d3cce-217">Détermine les paramètres utilisés pour créer le cookie .</span><span class="sxs-lookup"><span data-stu-id="d3cce-217">Determines the settings used to create the cookie.</span></span> <span data-ttu-id="d3cce-218"><xref:Microsoft.AspNetCore.Http.CookieBuilder.Name> la valeur par défaut est <xref:Microsoft.AspNetCore.Session.SessionDefaults.CookieName?displayProperty=nameWithType> ( `.AspNetCore.Session` ).</span><span class="sxs-lookup"><span data-stu-id="d3cce-218"><xref:Microsoft.AspNetCore.Http.CookieBuilder.Name> defaults to <xref:Microsoft.AspNetCore.Session.SessionDefaults.CookieName?displayProperty=nameWithType> (`.AspNetCore.Session`).</span></span> <span data-ttu-id="d3cce-219"><xref:Microsoft.AspNetCore.Http.CookieBuilder.Path> la valeur par défaut est <xref:Microsoft.AspNetCore.Session.SessionDefaults.CookiePath?displayProperty=nameWithType> ( `/` ).</span><span class="sxs-lookup"><span data-stu-id="d3cce-219"><xref:Microsoft.AspNetCore.Http.CookieBuilder.Path> defaults to <xref:Microsoft.AspNetCore.Session.SessionDefaults.CookiePath?displayProperty=nameWithType> (`/`).</span></span> <span data-ttu-id="d3cce-220"><xref:Microsoft.AspNetCore.Http.CookieBuilder.SameSite> la valeur par défaut est <xref:Microsoft.AspNetCore.Http.SameSiteMode.Lax?displayProperty=nameWithType> ( `1` ).</span><span class="sxs-lookup"><span data-stu-id="d3cce-220"><xref:Microsoft.AspNetCore.Http.CookieBuilder.SameSite> defaults to <xref:Microsoft.AspNetCore.Http.SameSiteMode.Lax?displayProperty=nameWithType> (`1`).</span></span> <span data-ttu-id="d3cce-221"><xref:Microsoft.AspNetCore.Http.CookieBuilder.HttpOnly> la valeur par défaut est `true` .</span><span class="sxs-lookup"><span data-stu-id="d3cce-221"><xref:Microsoft.AspNetCore.Http.CookieBuilder.HttpOnly> defaults to `true`.</span></span> <span data-ttu-id="d3cce-222"><xref:Microsoft.AspNetCore.Http.CookieBuilder.IsEssential> la valeur par défaut est `false` .</span><span class="sxs-lookup"><span data-stu-id="d3cce-222"><xref:Microsoft.AspNetCore.Http.CookieBuilder.IsEssential> defaults to `false`.</span></span> |
| <xref:Microsoft.AspNetCore.Builder.SessionOptions.IdleTimeout> | <span data-ttu-id="d3cce-223">`IdleTimeout` indique la durée pendant laquelle la session peut être inactive avant que son contenu soit abandonné.</span><span class="sxs-lookup"><span data-stu-id="d3cce-223">The `IdleTimeout` indicates how long the session can be idle before its contents are abandoned.</span></span> <span data-ttu-id="d3cce-224">Chaque accès à la session réinitialise le délai d’expiration.</span><span class="sxs-lookup"><span data-stu-id="d3cce-224">Each session access resets the timeout.</span></span> <span data-ttu-id="d3cce-225">Ce paramètre s’applique uniquement au contenu de la session, pas au cookie .</span><span class="sxs-lookup"><span data-stu-id="d3cce-225">This setting only applies to the content of the session, not the cookie.</span></span> <span data-ttu-id="d3cce-226">La valeur par défaut est 20 minutes.</span><span class="sxs-lookup"><span data-stu-id="d3cce-226">The default is 20 minutes.</span></span> |
| <xref:Microsoft.AspNetCore.Builder.SessionOptions.IOTimeout> | <span data-ttu-id="d3cce-227">Durée maximale autorisée pour charger une session à partir du magasin ou pour la valider dans le magasin.</span><span class="sxs-lookup"><span data-stu-id="d3cce-227">The maximum amount of time allowed to load a session from the store or to commit it back to the store.</span></span> <span data-ttu-id="d3cce-228">Ce paramètre peut s’appliquer uniquement aux opérations asynchrones.</span><span class="sxs-lookup"><span data-stu-id="d3cce-228">This setting may only apply to asynchronous operations.</span></span> <span data-ttu-id="d3cce-229">Ce délai d’expiration peut être désactivé à l’aide de <xref:System.Threading.Timeout.InfiniteTimeSpan> .</span><span class="sxs-lookup"><span data-stu-id="d3cce-229">This timeout can be disabled using <xref:System.Threading.Timeout.InfiniteTimeSpan>.</span></span> <span data-ttu-id="d3cce-230">La valeur par défaut est de 1 minute.</span><span class="sxs-lookup"><span data-stu-id="d3cce-230">The default is 1 minute.</span></span> |

<span data-ttu-id="d3cce-231">La session utilise un cookie pour suivre et identifier les demandes d’un navigateur unique.</span><span class="sxs-lookup"><span data-stu-id="d3cce-231">Session uses a cookie to track and identify requests from a single browser.</span></span> <span data-ttu-id="d3cce-232">Par défaut, ce cookie nom est nommé `.AspNetCore.Session` et utilise le chemin d’accès `/` .</span><span class="sxs-lookup"><span data-stu-id="d3cce-232">By default, this cookie is named `.AspNetCore.Session`, and it uses a path of `/`.</span></span> <span data-ttu-id="d3cce-233">Étant donné que la cookie valeur par défaut ne spécifie pas de domaine, elle n’est pas mise à la disposition du script côté client sur la page (car la <xref:Microsoft.AspNetCore.Http.CookieBuilder.HttpOnly> valeur par défaut est `true` ).</span><span class="sxs-lookup"><span data-stu-id="d3cce-233">Because the cookie default doesn't specify a domain, it isn't made available to the client-side script on the page (because <xref:Microsoft.AspNetCore.Http.CookieBuilder.HttpOnly> defaults to `true`).</span></span>

<span data-ttu-id="d3cce-234">Pour remplacer les cookie valeurs par défaut de la session, utilisez <xref:Microsoft.AspNetCore.Builder.SessionOptions> :</span><span class="sxs-lookup"><span data-stu-id="d3cce-234">To override cookie session defaults, use <xref:Microsoft.AspNetCore.Builder.SessionOptions>:</span></span>

[!code-csharp[](app-state/samples/3.x/SessionSample/Startup2.cs?name=snippet1&highlight=5-10)]

<span data-ttu-id="d3cce-235">L’application utilise la <xref:Microsoft.AspNetCore.Builder.SessionOptions.IdleTimeout> propriété pour déterminer la durée pendant laquelle une session peut être inactive avant que son contenu dans le cache du serveur soit abandonné.</span><span class="sxs-lookup"><span data-stu-id="d3cce-235">The app uses the <xref:Microsoft.AspNetCore.Builder.SessionOptions.IdleTimeout> property to determine how long a session can be idle before its contents in the server's cache are abandoned.</span></span> <span data-ttu-id="d3cce-236">Cette propriété est indépendante de l' cookie expiration.</span><span class="sxs-lookup"><span data-stu-id="d3cce-236">This property is independent of the cookie expiration.</span></span> <span data-ttu-id="d3cce-237">Chaque requête qui passe par le [middleware Session](xref:Microsoft.AspNetCore.Session.SessionMiddleware) réinitialise le délai d’expiration.</span><span class="sxs-lookup"><span data-stu-id="d3cce-237">Each request that passes through the [Session Middleware](xref:Microsoft.AspNetCore.Session.SessionMiddleware) resets the timeout.</span></span>

<span data-ttu-id="d3cce-238">L’état de session est *sans verrouillage*.</span><span class="sxs-lookup"><span data-stu-id="d3cce-238">Session state is *non-locking*.</span></span> <span data-ttu-id="d3cce-239">Si deux requêtes tentent simultanément de modifier le contenu d’une session, la dernière requête remplace la première.</span><span class="sxs-lookup"><span data-stu-id="d3cce-239">If two requests simultaneously attempt to modify the contents of a session, the last request overrides the first.</span></span> <span data-ttu-id="d3cce-240">`Session` est implémentée comme une *session cohérente*, ce qui signifie que tout le contenu est stocké au même emplacement.</span><span class="sxs-lookup"><span data-stu-id="d3cce-240">`Session` is implemented as a *coherent session*, which means that all the contents are stored together.</span></span> <span data-ttu-id="d3cce-241">Quand deux requêtes tentent de modifier différentes valeurs de session, la dernière requête peut remplacer les modifications de session effectuées par la première.</span><span class="sxs-lookup"><span data-stu-id="d3cce-241">When two requests seek to modify different session values, the last request may override session changes made by the first.</span></span>

### <a name="set-and-get-session-values"></a><span data-ttu-id="d3cce-242">Définir et obtenir des valeurs Session</span><span class="sxs-lookup"><span data-stu-id="d3cce-242">Set and get Session values</span></span>

<span data-ttu-id="d3cce-243">L’état de session est accessible à partir d’une Razor classe pages ou d’une <xref:Microsoft.AspNetCore.Mvc.RazorPages.PageModel> <xref:Microsoft.AspNetCore.Mvc.Controller> classe MVC avec <xref:Microsoft.AspNetCore.Http.HttpContext.Session?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="d3cce-243">Session state is accessed from a Razor Pages <xref:Microsoft.AspNetCore.Mvc.RazorPages.PageModel> class or MVC <xref:Microsoft.AspNetCore.Mvc.Controller> class with <xref:Microsoft.AspNetCore.Http.HttpContext.Session?displayProperty=nameWithType>.</span></span> <span data-ttu-id="d3cce-244">Cette propriété est une <xref:Microsoft.AspNetCore.Http.ISession> implémentation.</span><span class="sxs-lookup"><span data-stu-id="d3cce-244">This property is an <xref:Microsoft.AspNetCore.Http.ISession> implementation.</span></span>

<span data-ttu-id="d3cce-245">L’implémentation de `ISession` fournit plusieurs méthodes d’extension pour définir et récupérer des valeurs de chaîne et d’entier.</span><span class="sxs-lookup"><span data-stu-id="d3cce-245">The `ISession` implementation provides several extension methods to set and retrieve integer and string values.</span></span> <span data-ttu-id="d3cce-246">Les méthodes d’extension se trouvent dans l' <xref:Microsoft.AspNetCore.Http> espace de noms.</span><span class="sxs-lookup"><span data-stu-id="d3cce-246">The extension methods are in the <xref:Microsoft.AspNetCore.Http> namespace.</span></span>

<span data-ttu-id="d3cce-247">Méthodes d’extension `ISession` :</span><span class="sxs-lookup"><span data-stu-id="d3cce-247">`ISession` extension methods:</span></span>

* [<span data-ttu-id="d3cce-248">Get(ISession, String)</span><span class="sxs-lookup"><span data-stu-id="d3cce-248">Get(ISession, String)</span></span>](xref:Microsoft.AspNetCore.Http.SessionExtensions.Get%2A)
* [<span data-ttu-id="d3cce-249">GetInt32(ISession, String)</span><span class="sxs-lookup"><span data-stu-id="d3cce-249">GetInt32(ISession, String)</span></span>](xref:Microsoft.AspNetCore.Http.SessionExtensions.GetInt32%2A)
* [<span data-ttu-id="d3cce-250">GetString(ISession, String)</span><span class="sxs-lookup"><span data-stu-id="d3cce-250">GetString(ISession, String)</span></span>](xref:Microsoft.AspNetCore.Http.SessionExtensions.GetString%2A)
* [<span data-ttu-id="d3cce-251">SetInt32(ISession, String, Int32)</span><span class="sxs-lookup"><span data-stu-id="d3cce-251">SetInt32(ISession, String, Int32)</span></span>](xref:Microsoft.AspNetCore.Http.SessionExtensions.SetInt32%2A)
* [<span data-ttu-id="d3cce-252">SetString(ISession, String, String)</span><span class="sxs-lookup"><span data-stu-id="d3cce-252">SetString(ISession, String, String)</span></span>](xref:Microsoft.AspNetCore.Http.SessionExtensions.SetString%2A)

<span data-ttu-id="d3cce-253">L’exemple suivant récupère la valeur de session de la `IndexModel.SessionKeyName` clé ( `_Name` dans l’exemple d’application) dans une Razor page pages :</span><span class="sxs-lookup"><span data-stu-id="d3cce-253">The following example retrieves the session value for the `IndexModel.SessionKeyName` key (`_Name` in the sample app) in a Razor Pages page:</span></span>

```csharp
@page
@using Microsoft.AspNetCore.Http
@model IndexModel

...

Name: @HttpContext.Session.GetString(IndexModel.SessionKeyName)
```

<span data-ttu-id="d3cce-254">L’exemple suivant montre comment définir et obtenir un entier et une chaîne :</span><span class="sxs-lookup"><span data-stu-id="d3cce-254">The following example shows how to set and get an integer and a string:</span></span>

[!code-csharp[](app-state/samples/3.x/SessionSample/Pages/Index.cshtml.cs?name=snippet1&highlight=18-19,22-23)]

<span data-ttu-id="d3cce-255">Toutes les données de session doivent être sérialisées pour activer un scénario de cache distribué, même si vous utilisez le cache en mémoire.</span><span class="sxs-lookup"><span data-stu-id="d3cce-255">All session data must be serialized to enable a distributed cache scenario, even when using the in-memory cache.</span></span> <span data-ttu-id="d3cce-256">Les sérialiseurs de chaînes et d’entiers sont fournis par les méthodes d’extension de <xref:Microsoft.AspNetCore.Http.ISession> .</span><span class="sxs-lookup"><span data-stu-id="d3cce-256">String and integer serializers are provided by the extension methods of <xref:Microsoft.AspNetCore.Http.ISession>.</span></span> <span data-ttu-id="d3cce-257">Les types complexes doivent être sérialisés par l’utilisateur à l’aide d’un autre mécanisme, tel que JSON.</span><span class="sxs-lookup"><span data-stu-id="d3cce-257">Complex types must be serialized by the user using another mechanism, such as JSON.</span></span>

<span data-ttu-id="d3cce-258">Utilisez l’exemple de code suivant pour sérialiser des objets :</span><span class="sxs-lookup"><span data-stu-id="d3cce-258">Use the following sample code to serialize objects:</span></span>

[!code-csharp[](app-state/samples/3.x/SessionSample/Extensions/SessionExtensions.cs?name=snippet1)]

<span data-ttu-id="d3cce-259">L’exemple suivant montre comment définir et obtenir un objet sérialisable avec la `SessionExtensions` classe :</span><span class="sxs-lookup"><span data-stu-id="d3cce-259">The following example shows how to set and get a serializable object with the `SessionExtensions` class:</span></span>

[!code-csharp[](app-state/samples/3.x/SessionSample/Pages/Index.cshtml.cs?name=snippet2)]

## <a name="tempdata"></a><span data-ttu-id="d3cce-260">TempData</span><span class="sxs-lookup"><span data-stu-id="d3cce-260">TempData</span></span>

<span data-ttu-id="d3cce-261">ASP.NET Core expose les Razor pages [TempData](xref:Microsoft.AspNetCore.Mvc.RazorPages.PageModel.TempData) ou Controller <xref:Microsoft.AspNetCore.Mvc.Controller.TempData> .</span><span class="sxs-lookup"><span data-stu-id="d3cce-261">ASP.NET Core exposes the Razor Pages [TempData](xref:Microsoft.AspNetCore.Mvc.RazorPages.PageModel.TempData) or Controller <xref:Microsoft.AspNetCore.Mvc.Controller.TempData>.</span></span> <span data-ttu-id="d3cce-262">Cette propriété stocke les données jusqu’à ce qu’elles soient lues dans une autre requête.</span><span class="sxs-lookup"><span data-stu-id="d3cce-262">This property stores data until it's read in another request.</span></span> <span data-ttu-id="d3cce-263">Les méthodes [Keep (String)](xref:Microsoft.AspNetCore.Mvc.ViewFeatures.ITempDataDictionary.Keep*) et [Peek (String)](xref:Microsoft.AspNetCore.Mvc.ViewFeatures.ITempDataDictionary.Peek*) peuvent être utilisées pour examiner les données sans suppression à la fin de la requête.</span><span class="sxs-lookup"><span data-stu-id="d3cce-263">The [Keep(String)](xref:Microsoft.AspNetCore.Mvc.ViewFeatures.ITempDataDictionary.Keep*) and [Peek(string)](xref:Microsoft.AspNetCore.Mvc.ViewFeatures.ITempDataDictionary.Peek*) methods can be used to examine the data without deletion at the end of the request.</span></span> <span data-ttu-id="d3cce-264">[Keep](xref:Microsoft.AspNetCore.Mvc.ViewFeatures.ITempDataDictionary.Keep*) marque tous les éléments dans le dictionnaire pour la rétention.</span><span class="sxs-lookup"><span data-stu-id="d3cce-264">[Keep](xref:Microsoft.AspNetCore.Mvc.ViewFeatures.ITempDataDictionary.Keep*) marks all items in the dictionary for retention.</span></span> <span data-ttu-id="d3cce-265">`TempData` est :</span><span class="sxs-lookup"><span data-stu-id="d3cce-265">`TempData` is:</span></span>

* <span data-ttu-id="d3cce-266">Utile pour la redirection quand des données sont requises pour plus d’une requête unique.</span><span class="sxs-lookup"><span data-stu-id="d3cce-266">Useful for redirection when data is required for more than a single request.</span></span>
* <span data-ttu-id="d3cce-267">Implémenté par les `TempData` fournisseurs à l’aide cookie de ou de l’état de session.</span><span class="sxs-lookup"><span data-stu-id="d3cce-267">Implemented by `TempData` providers using either cookies or session state.</span></span>

## <a name="tempdata-samples"></a><span data-ttu-id="d3cce-268">Exemples TempData</span><span class="sxs-lookup"><span data-stu-id="d3cce-268">TempData samples</span></span>

<span data-ttu-id="d3cce-269">Examinez la page suivante qui crée un client :</span><span class="sxs-lookup"><span data-stu-id="d3cce-269">Consider the following page that creates a customer:</span></span>

[!code-csharp[](app-state/3.0samples/RazorPagesContacts/Pages/Customers/Create.cshtml.cs?name=snippet&highlight=15-16,30)]

<span data-ttu-id="d3cce-270">La page suivante affiche `TempData["Message"]` :</span><span class="sxs-lookup"><span data-stu-id="d3cce-270">The following page displays `TempData["Message"]`:</span></span>

[!code-cshtml[](app-state/3.0samples/RazorPagesContacts/Pages/Customers/IndexPeek.cshtml?range=1-14)]

<span data-ttu-id="d3cce-271">Dans le balisage précédent, à la fin de la demande, `TempData["Message"]` n’est **pas** supprimé, car `Peek` est utilisé.</span><span class="sxs-lookup"><span data-stu-id="d3cce-271">In the preceding markup, at the end of the request, `TempData["Message"]` is **not** deleted because `Peek` is used.</span></span> <span data-ttu-id="d3cce-272">L’actualisation de la page affiche le contenu de `TempData["Message"]` .</span><span class="sxs-lookup"><span data-stu-id="d3cce-272">Refreshing the page displays the contents of `TempData["Message"]`.</span></span>

<span data-ttu-id="d3cce-273">Le balisage suivant est semblable au code précédent, mais utilise `Keep` pour conserver les données à la fin de la requête :</span><span class="sxs-lookup"><span data-stu-id="d3cce-273">The following markup is similar to the preceding code, but uses `Keep` to preserve the data at the end of the request:</span></span>

[!code-cshtml[](app-state/3.0samples/RazorPagesContacts/Pages/Customers/IndexKeep.cshtml?range=1-14)]

<span data-ttu-id="d3cce-274">La navigation entre les pages *IndexPeek* et *IndexKeep* ne sera pas supprimée `TempData["Message"]` .</span><span class="sxs-lookup"><span data-stu-id="d3cce-274">Navigating between the *IndexPeek* and *IndexKeep* pages won't delete `TempData["Message"]`.</span></span>

<span data-ttu-id="d3cce-275">Le code suivant affiche `TempData["Message"]` , mais à la fin de la demande, `TempData["Message"]` est supprimé :</span><span class="sxs-lookup"><span data-stu-id="d3cce-275">The following code displays `TempData["Message"]`, but at the end of the request, `TempData["Message"]` is deleted:</span></span>

[!code-cshtml[](app-state/3.0samples/RazorPagesContacts/Pages/Customers/Index.cshtml?range=1-14)]

### <a name="tempdata-providers"></a><span data-ttu-id="d3cce-276">Fournisseurs TempData</span><span class="sxs-lookup"><span data-stu-id="d3cce-276">TempData providers</span></span>

<span data-ttu-id="d3cce-277">Le cookie fournisseur TempData basé sur utilise par défaut pour stocker TempData dans cookie s.</span><span class="sxs-lookup"><span data-stu-id="d3cce-277">The cookie-based TempData provider is used by default to store TempData in cookies.</span></span>

<span data-ttu-id="d3cce-278">Les cookie données sont chiffrées à l’aide de <xref:Microsoft.AspNetCore.DataProtection.IDataProtector> , encodées avec <xref:Microsoft.AspNetCore.WebUtilities.Base64UrlTextEncoder> , puis segmentées.</span><span class="sxs-lookup"><span data-stu-id="d3cce-278">The cookie data is encrypted using <xref:Microsoft.AspNetCore.DataProtection.IDataProtector>, encoded with <xref:Microsoft.AspNetCore.WebUtilities.Base64UrlTextEncoder>, then chunked.</span></span> <span data-ttu-id="d3cce-279">La cookie taille maximale est inférieure à [4096 octets](http://www.faqs.org/rfcs/rfc2965.html) en raison du chiffrement et de la segmentation.</span><span class="sxs-lookup"><span data-stu-id="d3cce-279">The maximum cookie size is less than [4096 bytes](http://www.faqs.org/rfcs/rfc2965.html) due to encryption and chunking.</span></span> <span data-ttu-id="d3cce-280">Les cookie données ne sont pas compressées, car la compression des données chiffrées peut entraîner des problèmes de sécurité tels que les attaques de [criminalité](https://wikipedia.org/wiki/CRIME_(security_exploit)) et de [violation](https://wikipedia.org/wiki/BREACH_(security_exploit)) .</span><span class="sxs-lookup"><span data-stu-id="d3cce-280">The cookie data isn't compressed because compressing encrypted data can lead to security problems such as the [CRIME](https://wikipedia.org/wiki/CRIME_(security_exploit)) and [BREACH](https://wikipedia.org/wiki/BREACH_(security_exploit)) attacks.</span></span> <span data-ttu-id="d3cce-281">Pour plus d’informations sur le cookie fournisseur TempData basé sur, consultez <xref:Microsoft.AspNetCore.Mvc.ViewFeatures.CookieTempDataProvider> .</span><span class="sxs-lookup"><span data-stu-id="d3cce-281">For more information on the cookie-based TempData provider, see <xref:Microsoft.AspNetCore.Mvc.ViewFeatures.CookieTempDataProvider>.</span></span>

### <a name="choose-a-tempdata-provider"></a><span data-ttu-id="d3cce-282">Choisir un fournisseur TempData</span><span class="sxs-lookup"><span data-stu-id="d3cce-282">Choose a TempData provider</span></span>

<span data-ttu-id="d3cce-283">Pour choisir un fournisseur TempData, vous devez tenir compte de plusieurs points. Par exemple :</span><span class="sxs-lookup"><span data-stu-id="d3cce-283">Choosing a TempData provider involves several considerations, such as:</span></span>

* <span data-ttu-id="d3cce-284">L’application utilise-t-elle déjà l’état de session ?</span><span class="sxs-lookup"><span data-stu-id="d3cce-284">Does the app already use session state?</span></span> <span data-ttu-id="d3cce-285">Dans ce cas, l’utilisation du fournisseur TempData d’état de session n’a pas de coût supplémentaire pour l’application au-delà de la taille des données.</span><span class="sxs-lookup"><span data-stu-id="d3cce-285">If so, using the session state TempData provider has no additional cost to the app beyond the size of the data.</span></span>
* <span data-ttu-id="d3cce-286">L’application utilise-t-elle uniquement la modération pour des quantités de données relativement petites, jusqu’à 500 octets ?</span><span class="sxs-lookup"><span data-stu-id="d3cce-286">Does the app use TempData only sparingly for relatively small amounts of data, up to 500 bytes?</span></span> <span data-ttu-id="d3cce-287">Si c’est le cas, le cookie fournisseur TempData ajoute un coût réduit à chaque demande qui transporte TempData.</span><span class="sxs-lookup"><span data-stu-id="d3cce-287">If so, the cookie TempData provider adds a small cost to each request that carries TempData.</span></span> <span data-ttu-id="d3cce-288">Si ce n’est pas le cas, le fournisseur TempData d’état de session peut être utile pour éviter l’aller-retour d’une grande quantité de données dans chaque requête jusqu’à ce que le TempData soit consommé.</span><span class="sxs-lookup"><span data-stu-id="d3cce-288">If not, the session state TempData provider can be beneficial to avoid round-tripping a large amount of data in each request until the TempData is consumed.</span></span>
* <span data-ttu-id="d3cce-289">L’application s’exécute-t-elle dans une batterie de serveurs sur plusieurs serveurs ?</span><span class="sxs-lookup"><span data-stu-id="d3cce-289">Does the app run in a server farm on multiple servers?</span></span> <span data-ttu-id="d3cce-290">Dans ce cas, aucune configuration supplémentaire n’est requise pour utiliser le cookie fournisseur TempData en dehors de la protection des données (voir <xref:security/data-protection/introduction> et [fournisseurs de stockage de clés](xref:security/data-protection/implementation/key-storage-providers)).</span><span class="sxs-lookup"><span data-stu-id="d3cce-290">If so, there's no additional configuration required to use the cookie TempData provider outside of Data Protection (see <xref:security/data-protection/introduction> and [Key storage providers](xref:security/data-protection/implementation/key-storage-providers)).</span></span>

<span data-ttu-id="d3cce-291">La plupart des clients Web, tels que les navigateurs Web, appliquent des limites sur la taille maximale de chaque cookie et le nombre total de cookie s.</span><span class="sxs-lookup"><span data-stu-id="d3cce-291">Most web clients such as web browsers enforce limits on the maximum size of each cookie and the total number of cookies.</span></span> <span data-ttu-id="d3cce-292">Lorsque vous utilisez le cookie fournisseur TempData, vérifiez que l’application ne dépasse pas [ces limites](http://www.faqs.org/rfcs/rfc2965.html).</span><span class="sxs-lookup"><span data-stu-id="d3cce-292">When using the cookie TempData provider, verify the app won't exceed [these limits](http://www.faqs.org/rfcs/rfc2965.html).</span></span> <span data-ttu-id="d3cce-293">Prenez en compte la taille totale des données.</span><span class="sxs-lookup"><span data-stu-id="d3cce-293">Consider the total size of the data.</span></span> <span data-ttu-id="d3cce-294">Compte de augmentation de la cookie taille en raison du chiffrement et de la segmentation.</span><span class="sxs-lookup"><span data-stu-id="d3cce-294">Account for increases in cookie size due to encryption and chunking.</span></span>

### <a name="configure-the-tempdata-provider"></a><span data-ttu-id="d3cce-295">Configuration du fournisseur TempData</span><span class="sxs-lookup"><span data-stu-id="d3cce-295">Configure the TempData provider</span></span>

<span data-ttu-id="d3cce-296">Le cookie fournisseur TempData basé sur est activé par défaut.</span><span class="sxs-lookup"><span data-stu-id="d3cce-296">The cookie-based TempData provider is enabled by default.</span></span>

<span data-ttu-id="d3cce-297">Pour activer le fournisseur TempData basé sur une session, utilisez la <xref:Microsoft.Extensions.DependencyInjection.MvcViewFeaturesMvcBuilderExtensions.AddSessionStateTempDataProvider%2A> méthode d’extension.</span><span class="sxs-lookup"><span data-stu-id="d3cce-297">To enable the session-based TempData provider, use the <xref:Microsoft.Extensions.DependencyInjection.MvcViewFeaturesMvcBuilderExtensions.AddSessionStateTempDataProvider%2A> extension method.</span></span> <span data-ttu-id="d3cce-298">Un seul appel à `AddSessionStateTempDataProvider` est requis :</span><span class="sxs-lookup"><span data-stu-id="d3cce-298">Only one call to `AddSessionStateTempDataProvider` is required:</span></span>

[!code-csharp[](app-state/samples/3.x/SessionSample/Startup3.cs?name=snippet1&highlight=4,6,8,30)]

## <a name="query-strings"></a><span data-ttu-id="d3cce-299">Chaînes de requête</span><span class="sxs-lookup"><span data-stu-id="d3cce-299">Query strings</span></span>

<span data-ttu-id="d3cce-300">Vous pouvez passer une quantité limitée de données d’une requête à une autre en l’ajoutant à la chaîne de la nouvelle requête.</span><span class="sxs-lookup"><span data-stu-id="d3cce-300">A limited amount of data can be passed from one request to another by adding it to the new request's query string.</span></span> <span data-ttu-id="d3cce-301">Cela est utile pour capturer l’état de manière persistante et permettre ainsi le partage de liens avec état incorporé par e-mail ou sur les réseaux sociaux.</span><span class="sxs-lookup"><span data-stu-id="d3cce-301">This is useful for capturing state in a persistent manner that allows links with embedded state to be shared through email or social networks.</span></span> <span data-ttu-id="d3cce-302">Les chaînes de requête URL étant publiques, vous ne devez jamais utiliser de chaînes de requête pour des données sensibles.</span><span class="sxs-lookup"><span data-stu-id="d3cce-302">Because URL query strings are public, never use query strings for sensitive data.</span></span>

<span data-ttu-id="d3cce-303">En plus du partage inattendu, les données des chaînes de requête peuvent exposer l’application à des attaques de [falsification de requête intersites (CSRF)](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)) .</span><span class="sxs-lookup"><span data-stu-id="d3cce-303">In addition to unintended sharing, including data in query strings can expose the app to [Cross-Site Request Forgery (CSRF)](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)) attacks.</span></span> <span data-ttu-id="d3cce-304">Tout état de session préservé doit se protéger contre les attaques CSRF.</span><span class="sxs-lookup"><span data-stu-id="d3cce-304">Any preserved session state must protect against CSRF attacks.</span></span> <span data-ttu-id="d3cce-305">Pour plus d'informations, consultez <xref:security/anti-request-forgery>.</span><span class="sxs-lookup"><span data-stu-id="d3cce-305">For more information, see <xref:security/anti-request-forgery>.</span></span>

## <a name="hidden-fields"></a><span data-ttu-id="d3cce-306">Champs masqués</span><span class="sxs-lookup"><span data-stu-id="d3cce-306">Hidden fields</span></span>

<span data-ttu-id="d3cce-307">Les données peuvent être enregistrées dans des champs de formulaire masqués et être republiées lors de la requête suivante.</span><span class="sxs-lookup"><span data-stu-id="d3cce-307">Data can be saved in hidden form fields and posted back on the next request.</span></span> <span data-ttu-id="d3cce-308">Cela est courant dans les formulaires de plusieurs pages.</span><span class="sxs-lookup"><span data-stu-id="d3cce-308">This is common in multi-page forms.</span></span> <span data-ttu-id="d3cce-309">Étant donné que le client peut potentiellement falsifier les données, l’application doit toujours revalider les données stockées dans les champs masqués.</span><span class="sxs-lookup"><span data-stu-id="d3cce-309">Because the client can potentially tamper with the data, the app must always revalidate the data stored in hidden fields.</span></span>

## <a name="httpcontextitems"></a><span data-ttu-id="d3cce-310">HttpContext.Items</span><span class="sxs-lookup"><span data-stu-id="d3cce-310">HttpContext.Items</span></span>

<span data-ttu-id="d3cce-311">La <xref:Microsoft.AspNetCore.Http.HttpContext.Items?displayProperty=nameWithType> collection est utilisée pour stocker des données lors du traitement d’une requête unique.</span><span class="sxs-lookup"><span data-stu-id="d3cce-311">The <xref:Microsoft.AspNetCore.Http.HttpContext.Items?displayProperty=nameWithType> collection is used to store data while processing a single request.</span></span> <span data-ttu-id="d3cce-312">Le contenu de la collection est supprimé une fois la requête traitée.</span><span class="sxs-lookup"><span data-stu-id="d3cce-312">The collection's contents are discarded after a request is processed.</span></span> <span data-ttu-id="d3cce-313">La collection `Items` est souvent utilisée pour permettre à des composants ou des middlewares de communiquer quand ils opèrent à différents moments de l’exécution d’une requête et qu’ils ne peuvent pas passer les paramètres de façon directe.</span><span class="sxs-lookup"><span data-stu-id="d3cce-313">The `Items` collection is often used to allow components or middleware to communicate when they operate at different points in time during a request and have no direct way to pass parameters.</span></span>

<span data-ttu-id="d3cce-314">Dans l’exemple suivant, l' [intergiciel (middleware](xref:fundamentals/middleware/index) ) s’ajoute `isVerified` à la `Items` collection :</span><span class="sxs-lookup"><span data-stu-id="d3cce-314">In the following example, [middleware](xref:fundamentals/middleware/index) adds `isVerified` to the `Items` collection:</span></span>

[!code-csharp[](app-state/samples/3.x/SessionSample/Startup.cs?name=snippet1)]

<span data-ttu-id="d3cce-315">Pour l’intergiciel (middleware) utilisé uniquement dans une application unique, les `string` clés fixes sont acceptables.</span><span class="sxs-lookup"><span data-stu-id="d3cce-315">For middleware that's only used in a single app, fixed `string` keys are acceptable.</span></span> <span data-ttu-id="d3cce-316">Les intergiciels (middleware) partagés entre les applications doivent utiliser des clés d’objet uniques pour éviter les collisions de clés.</span><span class="sxs-lookup"><span data-stu-id="d3cce-316">Middleware shared between apps should use unique object keys to avoid key collisions.</span></span> <span data-ttu-id="d3cce-317">L’exemple suivant montre comment utiliser une clé d’objet unique définie dans une classe de middleware :</span><span class="sxs-lookup"><span data-stu-id="d3cce-317">The following example shows how to use a unique object key defined in a middleware class:</span></span>

[!code-csharp[](app-state/samples/3.x/SessionSample/Middleware/HttpContextItemsMiddleware.cs?name=snippet1&highlight=4,13)]

<span data-ttu-id="d3cce-318">Tout autre code peut accéder à la valeur stockée dans `HttpContext.Items` à l’aide de la clé exposée par la classe du middleware :</span><span class="sxs-lookup"><span data-stu-id="d3cce-318">Other code can access the value stored in `HttpContext.Items` using the key exposed by the middleware class:</span></span>

[!code-csharp[](app-state/samples/3.x/SessionSample/Pages/Index.cshtml.cs?name=snippet3)]

<span data-ttu-id="d3cce-319">Cette approche a également l’avantage d’éliminer l’utilisation des chaînes de clés dans le code.</span><span class="sxs-lookup"><span data-stu-id="d3cce-319">This approach also has the advantage of eliminating the use of key strings in the code.</span></span>

## <a name="cache"></a><span data-ttu-id="d3cce-320">d'instance/de clé</span><span class="sxs-lookup"><span data-stu-id="d3cce-320">Cache</span></span>

<span data-ttu-id="d3cce-321">La mise en cache est un moyen efficace de stocker et récupérer des données.</span><span class="sxs-lookup"><span data-stu-id="d3cce-321">Caching is an efficient way to store and retrieve data.</span></span> <span data-ttu-id="d3cce-322">L’application peut contrôler la durée de vie des éléments mis en cache.</span><span class="sxs-lookup"><span data-stu-id="d3cce-322">The app can control the lifetime of cached items.</span></span> <span data-ttu-id="d3cce-323">Pour plus d'informations, consultez <xref:performance/caching/response>.</span><span class="sxs-lookup"><span data-stu-id="d3cce-323">For more information, see <xref:performance/caching/response>.</span></span>

<span data-ttu-id="d3cce-324">Les données mises en cache ne sont pas associées à une requête, un utilisateur ou une session spécifique.</span><span class="sxs-lookup"><span data-stu-id="d3cce-324">Cached data isn't associated with a specific request, user, or session.</span></span> <span data-ttu-id="d3cce-325">**Ne mettez pas en cache les données spécifiques à l’utilisateur qui peuvent être récupérées par d’autres demandes de l’utilisateur.**</span><span class="sxs-lookup"><span data-stu-id="d3cce-325">**Do not cache user-specific data that may be retrieved by other user requests.**</span></span>

<span data-ttu-id="d3cce-326">Pour mettre en cache des données à l’ensemble de l’application, consultez <xref:performance/caching/memory> .</span><span class="sxs-lookup"><span data-stu-id="d3cce-326">To cache application wide data, see <xref:performance/caching/memory>.</span></span>

## <a name="common-errors"></a><span data-ttu-id="d3cce-327">Erreurs courantes</span><span class="sxs-lookup"><span data-stu-id="d3cce-327">Common errors</span></span>

* <span data-ttu-id="d3cce-328">« Impossible de résoudre le service pour le type 'Microsoft.Extensions.Caching.Distributed.IDistributedCache' lors de la tentative d’activation de 'Microsoft.AspNetCore.Session.DistributedSessionStore'. »</span><span class="sxs-lookup"><span data-stu-id="d3cce-328">"Unable to resolve service for type 'Microsoft.Extensions.Caching.Distributed.IDistributedCache' while attempting to activate 'Microsoft.AspNetCore.Session.DistributedSessionStore'."</span></span>

  <span data-ttu-id="d3cce-329">Cela est généralement dû à l’impossibilité de configurer au moins une `IDistributedCache` implémentation.</span><span class="sxs-lookup"><span data-stu-id="d3cce-329">This is typically caused by failing to configure at least one `IDistributedCache` implementation.</span></span> <span data-ttu-id="d3cce-330">Pour plus d’informations, consultez <xref:performance/caching/distributed> et <xref:performance/caching/memory>.</span><span class="sxs-lookup"><span data-stu-id="d3cce-330">For more information, see <xref:performance/caching/distributed> and <xref:performance/caching/memory>.</span></span>

<span data-ttu-id="d3cce-331">Si le middleware de session ne parvient pas à rendre une session persistante :</span><span class="sxs-lookup"><span data-stu-id="d3cce-331">If the session middleware fails to persist a session:</span></span>

* <span data-ttu-id="d3cce-332">L’intergiciel enregistre l’exception et la demande se poursuit normalement.</span><span class="sxs-lookup"><span data-stu-id="d3cce-332">The middleware logs the exception and the request continues normally.</span></span>
* <span data-ttu-id="d3cce-333">Cela entraîne un comportement imprévisible.</span><span class="sxs-lookup"><span data-stu-id="d3cce-333">This leads to unpredictable behavior.</span></span>

<span data-ttu-id="d3cce-334">L’intergiciel de session ne peut pas conserver une session si le magasin de stockage n’est pas disponible.</span><span class="sxs-lookup"><span data-stu-id="d3cce-334">The session middleware can fail to persist a session if the backing store isn't available.</span></span> <span data-ttu-id="d3cce-335">Par exemple, imaginez qu’un utilisateur stocke un panier d’achat dans la session.</span><span class="sxs-lookup"><span data-stu-id="d3cce-335">For example, a user stores a shopping cart in session.</span></span> <span data-ttu-id="d3cce-336">Il ajoute un élément au panier, mais la validation échoue.</span><span class="sxs-lookup"><span data-stu-id="d3cce-336">The user adds an item to the cart but the commit fails.</span></span> <span data-ttu-id="d3cce-337">L’application n’a pas connaissance de l’échec et signale donc à l’utilisateur que l’élément a été ajouté au panier, ce qui est faux.</span><span class="sxs-lookup"><span data-stu-id="d3cce-337">The app doesn't know about the failure so it reports to the user that the item was added to their cart, which isn't true.</span></span>

<span data-ttu-id="d3cce-338">L’approche recommandée pour rechercher des erreurs consiste à appeler `await feature.Session.CommitAsync` lorsque l’application a terminé l’écriture dans la session.</span><span class="sxs-lookup"><span data-stu-id="d3cce-338">The recommended approach to check for errors is to call `await feature.Session.CommitAsync` when the app is done writing to the session.</span></span> <span data-ttu-id="d3cce-339"><xref:Microsoft.AspNetCore.Http.ISession.CommitAsync*> lève une exception si le magasin de stockage n’est pas disponible.</span><span class="sxs-lookup"><span data-stu-id="d3cce-339"><xref:Microsoft.AspNetCore.Http.ISession.CommitAsync*> throws an exception if the backing store is unavailable.</span></span> <span data-ttu-id="d3cce-340">Si `CommitAsync` échoue, l’application peut traiter l’exception.</span><span class="sxs-lookup"><span data-stu-id="d3cce-340">If `CommitAsync` fails, the app can process the exception.</span></span> <span data-ttu-id="d3cce-341"><xref:Microsoft.AspNetCore.Http.ISession.LoadAsync*> lève une exception dans les mêmes conditions lorsque le magasin de données n’est pas disponible.</span><span class="sxs-lookup"><span data-stu-id="d3cce-341"><xref:Microsoft.AspNetCore.Http.ISession.LoadAsync*> throws under the same conditions when the data store is unavailable.</span></span>
  
## <a name="no-locsignalr-and-session-state"></a><span data-ttu-id="d3cce-342">SignalR et état de session</span><span class="sxs-lookup"><span data-stu-id="d3cce-342">SignalR and session state</span></span>

<span data-ttu-id="d3cce-343">SignalR les applications ne doivent pas utiliser l’état de session pour stocker des informations.</span><span class="sxs-lookup"><span data-stu-id="d3cce-343">SignalR apps should not use session state to store information.</span></span> <span data-ttu-id="d3cce-344">SignalR les applications peuvent stocker par État de connexion dans `Context.Items` le Hub.</span><span class="sxs-lookup"><span data-stu-id="d3cce-344">SignalR apps can store per connection state in `Context.Items` in the hub.</span></span> <!-- https://github.com/aspnet/SignalR/issues/2139 -->

## <a name="additional-resources"></a><span data-ttu-id="d3cce-345">Ressources complémentaires</span><span class="sxs-lookup"><span data-stu-id="d3cce-345">Additional resources</span></span>

<xref:host-and-deploy/web-farm>
::: moniker-end

::: moniker range="< aspnetcore-3.0"

<span data-ttu-id="d3cce-346">Par [Rick Anderson](https://twitter.com/RickAndMSFT), [Steve Smith](https://ardalis.com/), [Diana LaRose](https://github.com/DianaLaRose) et [Luke Latham](https://github.com/guardrex)</span><span class="sxs-lookup"><span data-stu-id="d3cce-346">By [Rick Anderson](https://twitter.com/RickAndMSFT), [Steve Smith](https://ardalis.com/), [Diana LaRose](https://github.com/DianaLaRose), and [Luke Latham](https://github.com/guardrex)</span></span>

<span data-ttu-id="d3cce-347">HTTP est un protocole sans état.</span><span class="sxs-lookup"><span data-stu-id="d3cce-347">HTTP is a stateless protocol.</span></span> <span data-ttu-id="d3cce-348">Sans effectuer des étapes supplémentaires, les requêtes HTTP sont des messages indépendants qui ne conservent pas les valeurs utilisateur ou l’état de l’application.</span><span class="sxs-lookup"><span data-stu-id="d3cce-348">Without taking additional steps, HTTP requests are independent messages that don't retain user values or app state.</span></span> <span data-ttu-id="d3cce-349">Cet article décrit plusieurs approches pour conserver l’état de l’application et les données utilisateur entre les requêtes.</span><span class="sxs-lookup"><span data-stu-id="d3cce-349">This article describes several approaches to preserve user data and app state between requests.</span></span>

<span data-ttu-id="d3cce-350">[Afficher ou télécharger l’exemple de code](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/fundamentals/app-state/samples) ([procédure de téléchargement](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="d3cce-350">[View or download sample code](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/fundamentals/app-state/samples) ([how to download](xref:index#how-to-download-a-sample))</span></span>

## <a name="state-management"></a><span data-ttu-id="d3cce-351">Gestion de l'état</span><span class="sxs-lookup"><span data-stu-id="d3cce-351">State management</span></span>

<span data-ttu-id="d3cce-352">L’état peut être stocké à l’aide de plusieurs approches.</span><span class="sxs-lookup"><span data-stu-id="d3cce-352">State can be stored using several approaches.</span></span> <span data-ttu-id="d3cce-353">Chacune d’elles est abordée plus loin dans cette rubrique.</span><span class="sxs-lookup"><span data-stu-id="d3cce-353">Each approach is described later in this topic.</span></span>

| <span data-ttu-id="d3cce-354">Approche du stockage</span><span class="sxs-lookup"><span data-stu-id="d3cce-354">Storage approach</span></span> | <span data-ttu-id="d3cce-355">Mécanisme de stockage</span><span class="sxs-lookup"><span data-stu-id="d3cce-355">Storage mechanism</span></span> |
| ---------------- | ----------------- |
| <span data-ttu-id="d3cce-356">[Cookiex](#cookies)</span><span class="sxs-lookup"><span data-stu-id="d3cce-356">[Cookies](#cookies)</span></span> | <span data-ttu-id="d3cce-357">HTTP cookie s (peut inclure des données stockées à l’aide du code d’application côté serveur)</span><span class="sxs-lookup"><span data-stu-id="d3cce-357">HTTP cookies (may include data stored using server-side app code)</span></span> |
| [<span data-ttu-id="d3cce-358">État de session</span><span class="sxs-lookup"><span data-stu-id="d3cce-358">Session state</span></span>](#session-state) | <span data-ttu-id="d3cce-359">HTTP cookie s et code d’application côté serveur</span><span class="sxs-lookup"><span data-stu-id="d3cce-359">HTTP cookies and server-side app code</span></span> |
| [<span data-ttu-id="d3cce-360">TempData</span><span class="sxs-lookup"><span data-stu-id="d3cce-360">TempData</span></span>](#tempdata) | <span data-ttu-id="d3cce-361">HTTP cookie s ou état de session</span><span class="sxs-lookup"><span data-stu-id="d3cce-361">HTTP cookies or session state</span></span> |
| [<span data-ttu-id="d3cce-362">Chaînes de requête</span><span class="sxs-lookup"><span data-stu-id="d3cce-362">Query strings</span></span>](#query-strings) | <span data-ttu-id="d3cce-363">Chaînes de requête HTTP</span><span class="sxs-lookup"><span data-stu-id="d3cce-363">HTTP query strings</span></span> |
| [<span data-ttu-id="d3cce-364">Champs masqués</span><span class="sxs-lookup"><span data-stu-id="d3cce-364">Hidden fields</span></span>](#hidden-fields) | <span data-ttu-id="d3cce-365">Champs de formulaires HTTP</span><span class="sxs-lookup"><span data-stu-id="d3cce-365">HTTP form fields</span></span> |
| [<span data-ttu-id="d3cce-366">HttpContext.Items</span><span class="sxs-lookup"><span data-stu-id="d3cce-366">HttpContext.Items</span></span>](#httpcontextitems) | <span data-ttu-id="d3cce-367">Code d’application côté serveur</span><span class="sxs-lookup"><span data-stu-id="d3cce-367">Server-side app code</span></span> |
| [<span data-ttu-id="d3cce-368">Cache</span><span class="sxs-lookup"><span data-stu-id="d3cce-368">Cache</span></span>](#cache) | <span data-ttu-id="d3cce-369">Code d’application côté serveur</span><span class="sxs-lookup"><span data-stu-id="d3cce-369">Server-side app code</span></span> |
| [<span data-ttu-id="d3cce-370">Injection de dépendances</span><span class="sxs-lookup"><span data-stu-id="d3cce-370">Dependency Injection</span></span>](#dependency-injection) | <span data-ttu-id="d3cce-371">Code d’application côté serveur</span><span class="sxs-lookup"><span data-stu-id="d3cce-371">Server-side app code</span></span> |

## <a name="no-loccookies"></a><span data-ttu-id="d3cce-372">Cookies</span><span class="sxs-lookup"><span data-stu-id="d3cce-372">Cookies</span></span>

<span data-ttu-id="d3cce-373">Cookiestocke les données entre les demandes.</span><span class="sxs-lookup"><span data-stu-id="d3cce-373">Cookies store data across requests.</span></span> <span data-ttu-id="d3cce-374">Étant donné que les cookie sont envoyés avec chaque demande, leur taille doit être réduite à un minimum.</span><span class="sxs-lookup"><span data-stu-id="d3cce-374">Because cookies are sent with every request, their size should be kept to a minimum.</span></span> <span data-ttu-id="d3cce-375">Dans l’idéal, seul un identificateur doit être stocké dans un cookie avec les données stockées par l’application.</span><span class="sxs-lookup"><span data-stu-id="d3cce-375">Ideally, only an identifier should be stored in a cookie with the data stored by the app.</span></span> <span data-ttu-id="d3cce-376">La plupart des navigateurs limitent la cookie taille à 4096 octets.</span><span class="sxs-lookup"><span data-stu-id="d3cce-376">Most browsers restrict cookie size to 4096 bytes.</span></span> <span data-ttu-id="d3cce-377">Seul un nombre limité de cookie s est disponible pour chaque domaine.</span><span class="sxs-lookup"><span data-stu-id="d3cce-377">Only a limited number of cookies are available for each domain.</span></span>

<span data-ttu-id="d3cce-378">Étant donné que cookie les s sont sujettes à falsification, elles doivent être validées par l’application.</span><span class="sxs-lookup"><span data-stu-id="d3cce-378">Because cookies are subject to tampering, they must be validated by the app.</span></span> <span data-ttu-id="d3cce-379">Cookiepeuvent être supprimés par les utilisateurs et expirent sur les clients.</span><span class="sxs-lookup"><span data-stu-id="d3cce-379">Cookies can be deleted by users and expire on clients.</span></span> <span data-ttu-id="d3cce-380">Toutefois, cookie les s sont généralement la forme la plus durable de la persistance des données sur le client.</span><span class="sxs-lookup"><span data-stu-id="d3cce-380">However, cookies are generally the most durable form of data persistence on the client.</span></span>

<span data-ttu-id="d3cce-381">Cookieles s sont souvent utilisées pour la personnalisation, où le contenu est personnalisé pour un utilisateur connu.</span><span class="sxs-lookup"><span data-stu-id="d3cce-381">Cookies are often used for personalization, where content is customized for a known user.</span></span> <span data-ttu-id="d3cce-382">L’utilisateur est uniquement identifié, et pas authentifié dans la plupart des cas.</span><span class="sxs-lookup"><span data-stu-id="d3cce-382">The user is only identified and not authenticated in most cases.</span></span> <span data-ttu-id="d3cce-383">Le cookie peut stocker le nom de l’utilisateur, le nom du compte ou un ID d’utilisateur unique (tel qu’un GUID).</span><span class="sxs-lookup"><span data-stu-id="d3cce-383">The cookie can store the user's name, account name, or unique user ID (such as a GUID).</span></span> <span data-ttu-id="d3cce-384">Vous pouvez ensuite utiliser le cookie pour accéder aux paramètres personnalisés de l’utilisateur, tels que la couleur d’arrière-plan de votre site Web préféré.</span><span class="sxs-lookup"><span data-stu-id="d3cce-384">You can then use the cookie to access the user's personalized settings, such as their preferred website background color.</span></span>

<span data-ttu-id="d3cce-385">Tenez-vous au respect de la réglementation générale relative à la [protection des données (RGPD) de l’Union européenne](https://ec.europa.eu/info/law/law-topic/data-protection) lors de l’émission et du cookie traitement des problèmes de confidentialité.</span><span class="sxs-lookup"><span data-stu-id="d3cce-385">Be mindful of the [European Union General Data Protection Regulations (GDPR)](https://ec.europa.eu/info/law/law-topic/data-protection) when issuing cookies and dealing with privacy concerns.</span></span> <span data-ttu-id="d3cce-386">Pour plus d’informations, consultez [Prise en charge du règlement général sur la protection des données (RGPD) de l’Union Européenne dans ASP.NET Core](xref:security/gdpr).</span><span class="sxs-lookup"><span data-stu-id="d3cce-386">For more information, see [General Data Protection Regulation (GDPR) support in ASP.NET Core](xref:security/gdpr).</span></span>

## <a name="session-state"></a><span data-ttu-id="d3cce-387">État de la session</span><span class="sxs-lookup"><span data-stu-id="d3cce-387">Session state</span></span>

<span data-ttu-id="d3cce-388">L’état de session est un scénario ASP.NET Core pour le stockage des données utilisateur pendant que l’utilisateur parcourt une application web.</span><span class="sxs-lookup"><span data-stu-id="d3cce-388">Session state is an ASP.NET Core scenario for storage of user data while the user browses a web app.</span></span> <span data-ttu-id="d3cce-389">L’état de session utilise un magasin tenu à jour par l’application afin de conserver les données entre les requêtes d’un client.</span><span class="sxs-lookup"><span data-stu-id="d3cce-389">Session state uses a store maintained by the app to persist data across requests from a client.</span></span> <span data-ttu-id="d3cce-390">Les données de session sont secondées par un cache et considérées comme des données éphémères (le site doit continuer à fonctionner sans elles).</span><span class="sxs-lookup"><span data-stu-id="d3cce-390">The session data is backed by a cache and considered ephemeral data&mdash;the site should continue to function without the session data.</span></span> <span data-ttu-id="d3cce-391">Les données d’application critiques doivent être stockées dans la base de données utilisateur et mises en cache dans la session uniquement à des fins d’optimisation des performances.</span><span class="sxs-lookup"><span data-stu-id="d3cce-391">Critical application data should be stored in the user database and cached in session only as a performance optimization.</span></span>

> [!NOTE]
> <span data-ttu-id="d3cce-392">La session n’est pas prise en charge dans les [SignalR](xref:signalr/index) applications, car un [ SignalR Hub](xref:signalr/hubs) peut s’exécuter indépendamment d’un contexte http.</span><span class="sxs-lookup"><span data-stu-id="d3cce-392">Session isn't supported in [SignalR](xref:signalr/index) apps because a [SignalR Hub](xref:signalr/hubs) may execute independent of an HTTP context.</span></span> <span data-ttu-id="d3cce-393">Par exemple, cela peut se produire quand une longue requête d’interrogation est ouverte par un hub au-delà de la durée de vie du contexte de la requête HTTP.</span><span class="sxs-lookup"><span data-stu-id="d3cce-393">For example, this can occur when a long polling request is held open by a hub beyond the lifetime of the request's HTTP context.</span></span>

<span data-ttu-id="d3cce-394">ASP.NET Core conserve l’état de session en fournissant un cookie au client qui contient un ID de session, qui est envoyé à l’application avec chaque demande.</span><span class="sxs-lookup"><span data-stu-id="d3cce-394">ASP.NET Core maintains session state by providing a cookie to the client that contains a session ID, which is sent to the app with each request.</span></span> <span data-ttu-id="d3cce-395">Le serveur utilise l’ID de session pour récupérer les données de session.</span><span class="sxs-lookup"><span data-stu-id="d3cce-395">The app uses the session ID to fetch the session data.</span></span>

<span data-ttu-id="d3cce-396">L’état de session présente les comportements suivants :</span><span class="sxs-lookup"><span data-stu-id="d3cce-396">Session state exhibits the following behaviors:</span></span>

* <span data-ttu-id="d3cce-397">Étant donné que la session cookie est spécifique au navigateur, les sessions ne sont pas partagées entre les navigateurs.</span><span class="sxs-lookup"><span data-stu-id="d3cce-397">Because the session cookie is specific to the browser, sessions aren't shared across browsers.</span></span>
* <span data-ttu-id="d3cce-398">cookieLes sessions sont supprimées à la fin de la session du navigateur.</span><span class="sxs-lookup"><span data-stu-id="d3cce-398">Session cookies are deleted when the browser session ends.</span></span>
* <span data-ttu-id="d3cce-399">Si une cookie est reçue pour une session ayant expiré, une nouvelle session qui utilise la même session est créée cookie .</span><span class="sxs-lookup"><span data-stu-id="d3cce-399">If a cookie is received for an expired session, a new session is created that uses the same session cookie.</span></span>
* <span data-ttu-id="d3cce-400">Les sessions vides ne sont pas conservées. La session doit avoir au moins une valeur définie pour pouvoir être conservée entre les requêtes.</span><span class="sxs-lookup"><span data-stu-id="d3cce-400">Empty sessions aren't retained&mdash;the session must have at least one value set into it to persist the session across requests.</span></span> <span data-ttu-id="d3cce-401">Quand une session n’est pas conservée, un nouvel ID de session est généré pour chaque nouvelle requête.</span><span class="sxs-lookup"><span data-stu-id="d3cce-401">When a session isn't retained, a new session ID is generated for each new request.</span></span>
* <span data-ttu-id="d3cce-402">L’application conserve une session pendant une période limitée après la dernière requête.</span><span class="sxs-lookup"><span data-stu-id="d3cce-402">The app retains a session for a limited time after the last request.</span></span> <span data-ttu-id="d3cce-403">L’application définit le délai d’expiration d’une session ou utilise la valeur par défaut de 20 minutes.</span><span class="sxs-lookup"><span data-stu-id="d3cce-403">The app either sets the session timeout or uses the default value of 20 minutes.</span></span> <span data-ttu-id="d3cce-404">L’état de session est idéal pour le stockage des données utilisateur qui sont propres à une session particulière, mais où les données ne nécessitent pas un stockage permanent entre les sessions.</span><span class="sxs-lookup"><span data-stu-id="d3cce-404">Session state is ideal for storing user data that's specific to a particular session but where the data doesn't require permanent storage across sessions.</span></span>
* <span data-ttu-id="d3cce-405">Les données de session sont supprimées lorsque l' <xref:Microsoft.AspNetCore.Http.ISession.Clear%2A?displayProperty=nameWithType> implémentation est appelée ou lorsque la session expire.</span><span class="sxs-lookup"><span data-stu-id="d3cce-405">Session data is deleted either when the <xref:Microsoft.AspNetCore.Http.ISession.Clear%2A?displayProperty=nameWithType> implementation is called or when the session expires.</span></span>
* <span data-ttu-id="d3cce-406">Il n’existe pas de mécanisme par défaut pour informer le code de l’application qu’un navigateur client a été fermé ou lorsque la session cookie est supprimée ou a expiré sur le client.</span><span class="sxs-lookup"><span data-stu-id="d3cce-406">There's no default mechanism to inform app code that a client browser has been closed or when the session cookie is deleted or expired on the client.</span></span>
* <span data-ttu-id="d3cce-407">Les modèles MVC et Razor pages ASP.net Core incluent la prise en charge de règlement général sur la protection des données (RGPD).</span><span class="sxs-lookup"><span data-stu-id="d3cce-407">The ASP.NET Core MVC and Razor pages templates include support for General Data Protection Regulation (GDPR).</span></span> <span data-ttu-id="d3cce-408">Les États cookie de session ne sont pas marqués comme étant essentiels par défaut, l’état de session ne fonctionne pas, sauf si le suivi est autorisé par le visiteur du site.</span><span class="sxs-lookup"><span data-stu-id="d3cce-408">Session state cookies aren't marked essential by default, so session state isn't functional unless tracking is permitted by the site visitor.</span></span> <span data-ttu-id="d3cce-409">Pour plus d'informations, consultez <xref:security/gdpr#tempdata-provider-and-session-state-cookies-arent-essential>.</span><span class="sxs-lookup"><span data-stu-id="d3cce-409">For more information, see <xref:security/gdpr#tempdata-provider-and-session-state-cookies-arent-essential>.</span></span>

> [!WARNING]
> <span data-ttu-id="d3cce-410">Ne stockez pas de données sensibles dans l’état de session.</span><span class="sxs-lookup"><span data-stu-id="d3cce-410">Don't store sensitive data in session state.</span></span> <span data-ttu-id="d3cce-411">Il se peut que l’utilisateur ne ferme pas le navigateur et n’efface pas la session cookie .</span><span class="sxs-lookup"><span data-stu-id="d3cce-411">The user might not close the browser and clear the session cookie.</span></span> <span data-ttu-id="d3cce-412">Certains navigateurs maintiennent des sessions valides cookie entre les fenêtres de navigateur.</span><span class="sxs-lookup"><span data-stu-id="d3cce-412">Some browsers maintain valid session cookies across browser windows.</span></span> <span data-ttu-id="d3cce-413">Une session peut ne pas être restreinte à un seul utilisateur &mdash; . l’utilisateur suivant peut continuer à parcourir l’application avec la même session cookie .</span><span class="sxs-lookup"><span data-stu-id="d3cce-413">A session might not be restricted to a single user&mdash;the next user might continue to browse the app with the same session cookie.</span></span>

<span data-ttu-id="d3cce-414">Le fournisseur de cache en mémoire stocke les données de session dans la mémoire du serveur où réside l’application.</span><span class="sxs-lookup"><span data-stu-id="d3cce-414">The in-memory cache provider stores session data in the memory of the server where the app resides.</span></span> <span data-ttu-id="d3cce-415">Dans un scénario de batterie de serveurs :</span><span class="sxs-lookup"><span data-stu-id="d3cce-415">In a server farm scenario:</span></span>

* <span data-ttu-id="d3cce-416">Utilisez des *sessions persistantes* pour lier chaque session à une instance d’application spécifique sur un serveur donné.</span><span class="sxs-lookup"><span data-stu-id="d3cce-416">Use *sticky sessions* to tie each session to a specific app instance on an individual server.</span></span> <span data-ttu-id="d3cce-417">[Azure App Service](https://azure.microsoft.com/services/app-service/) utilise [Application Request Routing (ARR)](/iis/extensions/planning-for-arr/using-the-application-request-routing-module) pour appliquer les sessions persistantes par défaut.</span><span class="sxs-lookup"><span data-stu-id="d3cce-417">[Azure App Service](https://azure.microsoft.com/services/app-service/) uses [Application Request Routing (ARR)](/iis/extensions/planning-for-arr/using-the-application-request-routing-module) to enforce sticky sessions by default.</span></span> <span data-ttu-id="d3cce-418">Toutefois, les sessions rémanentes peuvent impacter l’extensibilité et compliquer les mises à jour des applications web.</span><span class="sxs-lookup"><span data-stu-id="d3cce-418">However, sticky sessions can affect scalability and complicate web app updates.</span></span> <span data-ttu-id="d3cce-419">Une meilleure approche consiste à utiliser le cache distribué Redis ou SQL Server, qui ne nécessite pas de sessions persistantes.</span><span class="sxs-lookup"><span data-stu-id="d3cce-419">A better approach is to use a Redis or SQL Server distributed cache, which doesn't require sticky sessions.</span></span> <span data-ttu-id="d3cce-420">Pour plus d'informations, consultez <xref:performance/caching/distributed>.</span><span class="sxs-lookup"><span data-stu-id="d3cce-420">For more information, see <xref:performance/caching/distributed>.</span></span>
* <span data-ttu-id="d3cce-421">La session cookie est chiffrée via <xref:Microsoft.AspNetCore.DataProtection.IDataProtector> .</span><span class="sxs-lookup"><span data-stu-id="d3cce-421">The session cookie is encrypted via <xref:Microsoft.AspNetCore.DataProtection.IDataProtector>.</span></span> <span data-ttu-id="d3cce-422">La protection des données doit être correctement configurée pour lire cookie les sessions sur chaque ordinateur.</span><span class="sxs-lookup"><span data-stu-id="d3cce-422">Data Protection must be properly configured to read session cookies on each machine.</span></span> <span data-ttu-id="d3cce-423">Pour plus d’informations, consultez <xref:security/data-protection/introduction> et [Fournisseurs de stockage de clés](xref:security/data-protection/implementation/key-storage-providers).</span><span class="sxs-lookup"><span data-stu-id="d3cce-423">For more information, see <xref:security/data-protection/introduction> and [Key storage providers](xref:security/data-protection/implementation/key-storage-providers).</span></span>

### <a name="configure-session-state"></a><span data-ttu-id="d3cce-424">Configurer l’état de session</span><span class="sxs-lookup"><span data-stu-id="d3cce-424">Configure session state</span></span>

<span data-ttu-id="d3cce-425">Le package [Microsoft.AspNetCore.Session](https://www.nuget.org/packages/Microsoft.AspNetCore.Session/), qui est inclus dans le [métapackage Microsoft.AspNetCore.App](xref:fundamentals/metapackage-app), fournit un middleware (intergiciel) pour gérer l’état de session.</span><span class="sxs-lookup"><span data-stu-id="d3cce-425">The [Microsoft.AspNetCore.Session](https://www.nuget.org/packages/Microsoft.AspNetCore.Session/) package, which is included in the [Microsoft.AspNetCore.App metapackage](xref:fundamentals/metapackage-app), provides middleware for managing session state.</span></span> <span data-ttu-id="d3cce-426">Pour activer le middleware Session, `Startup` doit contenir les éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="d3cce-426">To enable the session middleware, `Startup` must contain:</span></span>

* <span data-ttu-id="d3cce-427">L’un des <xref:Microsoft.Extensions.Caching.Distributed.IDistributedCache> caches de mémoire.</span><span class="sxs-lookup"><span data-stu-id="d3cce-427">Any of the <xref:Microsoft.Extensions.Caching.Distributed.IDistributedCache> memory caches.</span></span> <span data-ttu-id="d3cce-428">L’implémentation `IDistributedCache` est utilisée comme magasin de stockage pour la session.</span><span class="sxs-lookup"><span data-stu-id="d3cce-428">The `IDistributedCache` implementation is used as a backing store for session.</span></span> <span data-ttu-id="d3cce-429">Pour plus d'informations, consultez <xref:performance/caching/distributed>.</span><span class="sxs-lookup"><span data-stu-id="d3cce-429">For more information, see <xref:performance/caching/distributed>.</span></span>
* <span data-ttu-id="d3cce-430">Appel à <xref:Microsoft.Extensions.DependencyInjection.SessionServiceCollectionExtensions.AddSession%2A> dans `ConfigureServices` .</span><span class="sxs-lookup"><span data-stu-id="d3cce-430">A call to <xref:Microsoft.Extensions.DependencyInjection.SessionServiceCollectionExtensions.AddSession%2A> in `ConfigureServices`.</span></span>
* <span data-ttu-id="d3cce-431">Appel à <xref:Microsoft.AspNetCore.Builder.SessionMiddlewareExtensions.UseSession%2A> dans `Configure` .</span><span class="sxs-lookup"><span data-stu-id="d3cce-431">A call to <xref:Microsoft.AspNetCore.Builder.SessionMiddlewareExtensions.UseSession%2A> in `Configure`.</span></span>

<span data-ttu-id="d3cce-432">Le code suivant montre comment configurer le fournisseur de session en mémoire avec une implémentation en mémoire par défaut de `IDistributedCache` :</span><span class="sxs-lookup"><span data-stu-id="d3cce-432">The following code shows how to set up the in-memory session provider with a default in-memory implementation of `IDistributedCache`:</span></span>

[!code-csharp[](app-state/samples/2.x/SessionSample/Startup.cs?name=snippet1&highlight=5-14,34)]

<span data-ttu-id="d3cce-433">L’ordre des middlewares est important.</span><span class="sxs-lookup"><span data-stu-id="d3cce-433">The order of middleware is important.</span></span> <span data-ttu-id="d3cce-434">Dans l’exemple précédent, une exception `InvalidOperationException` se produit quand `UseSession` est appelée après `UseMvc`.</span><span class="sxs-lookup"><span data-stu-id="d3cce-434">In the preceding example, an `InvalidOperationException` exception occurs when `UseSession` is invoked after `UseMvc`.</span></span> <span data-ttu-id="d3cce-435">Pour plus d’informations, consultez [Ordre des intergiciels (middleware)](xref:fundamentals/middleware/index#order).</span><span class="sxs-lookup"><span data-stu-id="d3cce-435">For more information, see [Middleware Ordering](xref:fundamentals/middleware/index#order).</span></span>

<span data-ttu-id="d3cce-436"><xref:Microsoft.AspNetCore.Http.HttpContext.Session?displayProperty=nameWithType> est disponible après la configuration de l’état de session.</span><span class="sxs-lookup"><span data-stu-id="d3cce-436"><xref:Microsoft.AspNetCore.Http.HttpContext.Session?displayProperty=nameWithType> is available after session state is configured.</span></span>

<span data-ttu-id="d3cce-437">`HttpContext.Session` n’est pas accessible avant que `UseSession` ait été appelée.</span><span class="sxs-lookup"><span data-stu-id="d3cce-437">`HttpContext.Session` can't be accessed before `UseSession` has been called.</span></span>

<span data-ttu-id="d3cce-438">Une nouvelle session avec une nouvelle session cookie ne peut pas être créée après que l’application a commencé l’écriture dans le flux de réponse.</span><span class="sxs-lookup"><span data-stu-id="d3cce-438">A new session with a new session cookie can't be created after the app has begun writing to the response stream.</span></span> <span data-ttu-id="d3cce-439">L’exception est enregistrée dans le journal de serveur web et n’est pas affichée pas dans le navigateur.</span><span class="sxs-lookup"><span data-stu-id="d3cce-439">The exception is recorded in the web server log and not displayed in the browser.</span></span>

### <a name="load-session-state-asynchronously"></a><span data-ttu-id="d3cce-440">Charger l’état de session de façon asynchrone</span><span class="sxs-lookup"><span data-stu-id="d3cce-440">Load session state asynchronously</span></span>

<span data-ttu-id="d3cce-441">Dans ASP.NET Core, le fournisseur de session par défaut charge les enregistrements de session à partir du magasin de stockage sous-jacent de <xref:Microsoft.Extensions.Caching.Distributed.IDistributedCache> façon asynchrone uniquement si la <xref:Microsoft.AspNetCore.Http.ISession.LoadAsync%2A?displayProperty=nameWithType> méthode est appelée explicitement avant les <xref:Microsoft.AspNetCore.Http.ISession.TryGetValue%2A> <xref:Microsoft.AspNetCore.Http.ISession.Set%2A> méthodes, ou <xref:Microsoft.AspNetCore.Http.ISession.Remove%2A> .</span><span class="sxs-lookup"><span data-stu-id="d3cce-441">The default session provider in ASP.NET Core loads session records from the underlying <xref:Microsoft.Extensions.Caching.Distributed.IDistributedCache> backing store asynchronously only if the <xref:Microsoft.AspNetCore.Http.ISession.LoadAsync%2A?displayProperty=nameWithType> method is explicitly called before the <xref:Microsoft.AspNetCore.Http.ISession.TryGetValue%2A>, <xref:Microsoft.AspNetCore.Http.ISession.Set%2A>, or <xref:Microsoft.AspNetCore.Http.ISession.Remove%2A> methods.</span></span> <span data-ttu-id="d3cce-442">Si `LoadAsync` n’est pas appelée en premier, l’enregistrement de session sous-jacent est chargé de façon synchrone, ce qui peut entraîner une baisse des performances à l’échelle.</span><span class="sxs-lookup"><span data-stu-id="d3cce-442">If `LoadAsync` isn't called first, the underlying session record is loaded synchronously, which can incur a performance penalty at scale.</span></span>

<span data-ttu-id="d3cce-443">Pour que les applications appliquent ce modèle, encapsulez les <xref:Microsoft.AspNetCore.Session.DistributedSessionStore> <xref:Microsoft.AspNetCore.Session.DistributedSession> implémentations et avec des versions qui lèvent une exception si la `LoadAsync` méthode n’est pas appelée avant `TryGetValue` , `Set` ou `Remove` .</span><span class="sxs-lookup"><span data-stu-id="d3cce-443">To have apps enforce this pattern, wrap the <xref:Microsoft.AspNetCore.Session.DistributedSessionStore> and <xref:Microsoft.AspNetCore.Session.DistributedSession> implementations with versions that throw an exception if the `LoadAsync` method isn't called before `TryGetValue`, `Set`, or `Remove`.</span></span> <span data-ttu-id="d3cce-444">Inscrivez ensuite les versions incluses dans le wrapper auprès du conteneur de services.</span><span class="sxs-lookup"><span data-stu-id="d3cce-444">Register the wrapped versions in the services container.</span></span>

### <a name="session-options"></a><span data-ttu-id="d3cce-445">Options de session</span><span class="sxs-lookup"><span data-stu-id="d3cce-445">Session options</span></span>

<span data-ttu-id="d3cce-446">Pour remplacer les valeurs par défaut de la session, utilisez <xref:Microsoft.AspNetCore.Builder.SessionOptions> .</span><span class="sxs-lookup"><span data-stu-id="d3cce-446">To override session defaults, use <xref:Microsoft.AspNetCore.Builder.SessionOptions>.</span></span>

| <span data-ttu-id="d3cce-447">Option</span><span class="sxs-lookup"><span data-stu-id="d3cce-447">Option</span></span> | <span data-ttu-id="d3cce-448">Description</span><span class="sxs-lookup"><span data-stu-id="d3cce-448">Description</span></span> |
| ------ | ----------- |
| <xref:Microsoft.AspNetCore.Builder.SessionOptions.Cookie> | <span data-ttu-id="d3cce-449">Détermine les paramètres utilisés pour créer le cookie .</span><span class="sxs-lookup"><span data-stu-id="d3cce-449">Determines the settings used to create the cookie.</span></span> <span data-ttu-id="d3cce-450"><xref:Microsoft.AspNetCore.Http.CookieBuilder.Name> la valeur par défaut est <xref:Microsoft.AspNetCore.Session.SessionDefaults.CookieName?displayProperty=nameWithType> ( `.AspNetCore.Session` ).</span><span class="sxs-lookup"><span data-stu-id="d3cce-450"><xref:Microsoft.AspNetCore.Http.CookieBuilder.Name> defaults to <xref:Microsoft.AspNetCore.Session.SessionDefaults.CookieName?displayProperty=nameWithType> (`.AspNetCore.Session`).</span></span> <span data-ttu-id="d3cce-451"><xref:Microsoft.AspNetCore.Http.CookieBuilder.Path> la valeur par défaut est <xref:Microsoft.AspNetCore.Session.SessionDefaults.CookiePath?displayProperty=nameWithType> ( `/` ).</span><span class="sxs-lookup"><span data-stu-id="d3cce-451"><xref:Microsoft.AspNetCore.Http.CookieBuilder.Path> defaults to <xref:Microsoft.AspNetCore.Session.SessionDefaults.CookiePath?displayProperty=nameWithType> (`/`).</span></span> <span data-ttu-id="d3cce-452"><xref:Microsoft.AspNetCore.Http.CookieBuilder.SameSite> la valeur par défaut est <xref:Microsoft.AspNetCore.Http.SameSiteMode.Lax?displayProperty=nameWithType> ( `1` ).</span><span class="sxs-lookup"><span data-stu-id="d3cce-452"><xref:Microsoft.AspNetCore.Http.CookieBuilder.SameSite> defaults to <xref:Microsoft.AspNetCore.Http.SameSiteMode.Lax?displayProperty=nameWithType> (`1`).</span></span> <span data-ttu-id="d3cce-453"><xref:Microsoft.AspNetCore.Http.CookieBuilder.HttpOnly> la valeur par défaut est `true` .</span><span class="sxs-lookup"><span data-stu-id="d3cce-453"><xref:Microsoft.AspNetCore.Http.CookieBuilder.HttpOnly> defaults to `true`.</span></span> <span data-ttu-id="d3cce-454"><xref:Microsoft.AspNetCore.Http.CookieBuilder.IsEssential> la valeur par défaut est `false` .</span><span class="sxs-lookup"><span data-stu-id="d3cce-454"><xref:Microsoft.AspNetCore.Http.CookieBuilder.IsEssential> defaults to `false`.</span></span> |
| <xref:Microsoft.AspNetCore.Builder.SessionOptions.IdleTimeout> | <span data-ttu-id="d3cce-455">`IdleTimeout` indique la durée pendant laquelle la session peut être inactive avant que son contenu soit abandonné.</span><span class="sxs-lookup"><span data-stu-id="d3cce-455">The `IdleTimeout` indicates how long the session can be idle before its contents are abandoned.</span></span> <span data-ttu-id="d3cce-456">Chaque accès à la session réinitialise le délai d’expiration.</span><span class="sxs-lookup"><span data-stu-id="d3cce-456">Each session access resets the timeout.</span></span> <span data-ttu-id="d3cce-457">Ce paramètre s’applique uniquement au contenu de la session, pas au cookie .</span><span class="sxs-lookup"><span data-stu-id="d3cce-457">This setting only applies to the content of the session, not the cookie.</span></span> <span data-ttu-id="d3cce-458">La valeur par défaut est 20 minutes.</span><span class="sxs-lookup"><span data-stu-id="d3cce-458">The default is 20 minutes.</span></span> |
| <xref:Microsoft.AspNetCore.Builder.SessionOptions.IOTimeout> | <span data-ttu-id="d3cce-459">Durée maximale autorisée pour charger une session à partir du magasin ou pour la valider dans le magasin.</span><span class="sxs-lookup"><span data-stu-id="d3cce-459">The maximum amount of time allowed to load a session from the store or to commit it back to the store.</span></span> <span data-ttu-id="d3cce-460">Ce paramètre peut s’appliquer uniquement aux opérations asynchrones.</span><span class="sxs-lookup"><span data-stu-id="d3cce-460">This setting may only apply to asynchronous operations.</span></span> <span data-ttu-id="d3cce-461">Ce délai d’expiration peut être désactivé à l’aide de <xref:System.Threading.Timeout.InfiniteTimeSpan> .</span><span class="sxs-lookup"><span data-stu-id="d3cce-461">This timeout can be disabled using <xref:System.Threading.Timeout.InfiniteTimeSpan>.</span></span> <span data-ttu-id="d3cce-462">La valeur par défaut est de 1 minute.</span><span class="sxs-lookup"><span data-stu-id="d3cce-462">The default is 1 minute.</span></span> |

<span data-ttu-id="d3cce-463">La session utilise un cookie pour suivre et identifier les demandes d’un navigateur unique.</span><span class="sxs-lookup"><span data-stu-id="d3cce-463">Session uses a cookie to track and identify requests from a single browser.</span></span> <span data-ttu-id="d3cce-464">Par défaut, ce cookie nom est nommé `.AspNetCore.Session` et utilise le chemin d’accès `/` .</span><span class="sxs-lookup"><span data-stu-id="d3cce-464">By default, this cookie is named `.AspNetCore.Session`, and it uses a path of `/`.</span></span> <span data-ttu-id="d3cce-465">Étant donné que la cookie valeur par défaut ne spécifie pas de domaine, elle n’est pas mise à la disposition du script côté client sur la page (car la <xref:Microsoft.AspNetCore.Http.CookieBuilder.HttpOnly> valeur par défaut est `true` ).</span><span class="sxs-lookup"><span data-stu-id="d3cce-465">Because the cookie default doesn't specify a domain, it isn't made available to the client-side script on the page (because <xref:Microsoft.AspNetCore.Http.CookieBuilder.HttpOnly> defaults to `true`).</span></span>

<span data-ttu-id="d3cce-466">Pour remplacer les cookie valeurs par défaut de la session, utilisez `SessionOptions` :</span><span class="sxs-lookup"><span data-stu-id="d3cce-466">To override cookie session defaults, use `SessionOptions`:</span></span>

[!code-csharp[](app-state/samples_snapshot/2.x/SessionSample/Startup.cs?name=snippet1&highlight=14-19)]

<span data-ttu-id="d3cce-467">L’application utilise la <xref:Microsoft.AspNetCore.Builder.SessionOptions.IdleTimeout> propriété pour déterminer la durée pendant laquelle une session peut être inactive avant que son contenu dans le cache du serveur soit abandonné.</span><span class="sxs-lookup"><span data-stu-id="d3cce-467">The app uses the <xref:Microsoft.AspNetCore.Builder.SessionOptions.IdleTimeout> property to determine how long a session can be idle before its contents in the server's cache are abandoned.</span></span> <span data-ttu-id="d3cce-468">Cette propriété est indépendante de l' cookie expiration.</span><span class="sxs-lookup"><span data-stu-id="d3cce-468">This property is independent of the cookie expiration.</span></span> <span data-ttu-id="d3cce-469">Chaque requête qui passe par le [middleware Session](xref:Microsoft.AspNetCore.Session.SessionMiddleware) réinitialise le délai d’expiration.</span><span class="sxs-lookup"><span data-stu-id="d3cce-469">Each request that passes through the [Session Middleware](xref:Microsoft.AspNetCore.Session.SessionMiddleware) resets the timeout.</span></span>

<span data-ttu-id="d3cce-470">L’état de session est *sans verrouillage*.</span><span class="sxs-lookup"><span data-stu-id="d3cce-470">Session state is *non-locking*.</span></span> <span data-ttu-id="d3cce-471">Si deux requêtes tentent simultanément de modifier le contenu d’une session, la dernière requête remplace la première.</span><span class="sxs-lookup"><span data-stu-id="d3cce-471">If two requests simultaneously attempt to modify the contents of a session, the last request overrides the first.</span></span> <span data-ttu-id="d3cce-472">`Session` est implémentée comme une *session cohérente*, ce qui signifie que tout le contenu est stocké au même emplacement.</span><span class="sxs-lookup"><span data-stu-id="d3cce-472">`Session` is implemented as a *coherent session*, which means that all the contents are stored together.</span></span> <span data-ttu-id="d3cce-473">Quand deux requêtes tentent de modifier différentes valeurs de session, la dernière requête peut remplacer les modifications de session effectuées par la première.</span><span class="sxs-lookup"><span data-stu-id="d3cce-473">When two requests seek to modify different session values, the last request may override session changes made by the first.</span></span>

### <a name="set-and-get-session-values"></a><span data-ttu-id="d3cce-474">Définir et obtenir des valeurs Session</span><span class="sxs-lookup"><span data-stu-id="d3cce-474">Set and get Session values</span></span>

<span data-ttu-id="d3cce-475">L’état de session est accessible à partir d’une Razor classe pages ou d’une <xref:Microsoft.AspNetCore.Mvc.RazorPages.PageModel> <xref:Microsoft.AspNetCore.Mvc.Controller> classe MVC avec <xref:Microsoft.AspNetCore.Http.HttpContext.Session?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="d3cce-475">Session state is accessed from a Razor Pages <xref:Microsoft.AspNetCore.Mvc.RazorPages.PageModel> class or MVC <xref:Microsoft.AspNetCore.Mvc.Controller> class with <xref:Microsoft.AspNetCore.Http.HttpContext.Session?displayProperty=nameWithType>.</span></span> <span data-ttu-id="d3cce-476">Cette propriété est une <xref:Microsoft.AspNetCore.Http.ISession> implémentation.</span><span class="sxs-lookup"><span data-stu-id="d3cce-476">This property is an <xref:Microsoft.AspNetCore.Http.ISession> implementation.</span></span>

<span data-ttu-id="d3cce-477">L’implémentation de `ISession` fournit plusieurs méthodes d’extension pour définir et récupérer des valeurs de chaîne et d’entier.</span><span class="sxs-lookup"><span data-stu-id="d3cce-477">The `ISession` implementation provides several extension methods to set and retrieve integer and string values.</span></span> <span data-ttu-id="d3cce-478">Les méthodes d’extension se trouvent dans l' <xref:Microsoft.AspNetCore.Http> espace de noms (ajoutez une `using Microsoft.AspNetCore.Http;` instruction pour accéder aux méthodes d’extension) quand le package [Microsoft. AspNetCore. http. extensions](https://www.nuget.org/packages/Microsoft.AspNetCore.Http.Extensions/) est référencé par le projet.</span><span class="sxs-lookup"><span data-stu-id="d3cce-478">The extension methods are in the <xref:Microsoft.AspNetCore.Http> namespace (add a `using Microsoft.AspNetCore.Http;` statement to gain access to the extension methods) when the [Microsoft.AspNetCore.Http.Extensions](https://www.nuget.org/packages/Microsoft.AspNetCore.Http.Extensions/) package is referenced by the project.</span></span> <span data-ttu-id="d3cce-479">Les deux packages sont inclus dans le [métapackage Microsoft.AspNetCore.App](xref:fundamentals/metapackage-app).</span><span class="sxs-lookup"><span data-stu-id="d3cce-479">Both packages are included in the [Microsoft.AspNetCore.App metapackage](xref:fundamentals/metapackage-app).</span></span>

<span data-ttu-id="d3cce-480">Méthodes d’extension `ISession` :</span><span class="sxs-lookup"><span data-stu-id="d3cce-480">`ISession` extension methods:</span></span>

* [<span data-ttu-id="d3cce-481">Get(ISession, String)</span><span class="sxs-lookup"><span data-stu-id="d3cce-481">Get(ISession, String)</span></span>](xref:Microsoft.AspNetCore.Http.SessionExtensions.Get%2A)
* [<span data-ttu-id="d3cce-482">GetInt32(ISession, String)</span><span class="sxs-lookup"><span data-stu-id="d3cce-482">GetInt32(ISession, String)</span></span>](xref:Microsoft.AspNetCore.Http.SessionExtensions.GetInt32%2A)
* [<span data-ttu-id="d3cce-483">GetString(ISession, String)</span><span class="sxs-lookup"><span data-stu-id="d3cce-483">GetString(ISession, String)</span></span>](xref:Microsoft.AspNetCore.Http.SessionExtensions.GetString%2A)
* [<span data-ttu-id="d3cce-484">SetInt32(ISession, String, Int32)</span><span class="sxs-lookup"><span data-stu-id="d3cce-484">SetInt32(ISession, String, Int32)</span></span>](xref:Microsoft.AspNetCore.Http.SessionExtensions.SetInt32%2A)
* [<span data-ttu-id="d3cce-485">SetString(ISession, String, String)</span><span class="sxs-lookup"><span data-stu-id="d3cce-485">SetString(ISession, String, String)</span></span>](xref:Microsoft.AspNetCore.Http.SessionExtensions.SetString%2A)

<span data-ttu-id="d3cce-486">L’exemple suivant récupère la valeur de session de la `IndexModel.SessionKeyName` clé ( `_Name` dans l’exemple d’application) dans une Razor page pages :</span><span class="sxs-lookup"><span data-stu-id="d3cce-486">The following example retrieves the session value for the `IndexModel.SessionKeyName` key (`_Name` in the sample app) in a Razor Pages page:</span></span>

```csharp
@page
@using Microsoft.AspNetCore.Http
@model IndexModel

...

Name: @HttpContext.Session.GetString(IndexModel.SessionKeyName)
```

<span data-ttu-id="d3cce-487">L’exemple suivant montre comment définir et obtenir un entier et une chaîne :</span><span class="sxs-lookup"><span data-stu-id="d3cce-487">The following example shows how to set and get an integer and a string:</span></span>

[!code-csharp[](app-state/samples/2.x/SessionSample/Pages/Index.cshtml.cs?name=snippet1&highlight=18-19,22-23)]

<span data-ttu-id="d3cce-488">Toutes les données de session doivent être sérialisées pour activer un scénario de cache distribué, même si vous utilisez le cache en mémoire.</span><span class="sxs-lookup"><span data-stu-id="d3cce-488">All session data must be serialized to enable a distributed cache scenario, even when using the in-memory cache.</span></span> <span data-ttu-id="d3cce-489">Les sérialiseurs de chaînes et d’entiers sont fournis par les méthodes d’extension de <xref:Microsoft.AspNetCore.Http.ISession> .</span><span class="sxs-lookup"><span data-stu-id="d3cce-489">String and integer serializers are provided by the extension methods of <xref:Microsoft.AspNetCore.Http.ISession>).</span></span> <span data-ttu-id="d3cce-490">Les types complexes doivent être sérialisés par l’utilisateur à l’aide d’un autre mécanisme, tel que JSON.</span><span class="sxs-lookup"><span data-stu-id="d3cce-490">Complex types must be serialized by the user using another mechanism, such as JSON.</span></span>

<span data-ttu-id="d3cce-491">Ajoutez les méthodes d’extension suivantes pour définir et obtenir des objets sérialisables :</span><span class="sxs-lookup"><span data-stu-id="d3cce-491">Add the following extension methods to set and get serializable objects:</span></span>

[!code-csharp[](app-state/samples/2.x/SessionSample/Extensions/SessionExtensions.cs?name=snippet1)]

<span data-ttu-id="d3cce-492">L’exemple suivant montre comment définir et obtenir un objet sérialisable avec les méthodes d’extension :</span><span class="sxs-lookup"><span data-stu-id="d3cce-492">The following example shows how to set and get a serializable object with the extension methods:</span></span>

[!code-csharp[](app-state/samples/2.x/SessionSample/Pages/Index.cshtml.cs?name=snippet2)]

## <a name="tempdata"></a><span data-ttu-id="d3cce-493">TempData</span><span class="sxs-lookup"><span data-stu-id="d3cce-493">TempData</span></span>

<span data-ttu-id="d3cce-494">ASP.NET Core expose les Razor pages [TempData](xref:Microsoft.AspNetCore.Mvc.RazorPages.PageModel.TempData) ou Controller <xref:Microsoft.AspNetCore.Mvc.Controller.TempData> .</span><span class="sxs-lookup"><span data-stu-id="d3cce-494">ASP.NET Core exposes the Razor Pages [TempData](xref:Microsoft.AspNetCore.Mvc.RazorPages.PageModel.TempData) or Controller <xref:Microsoft.AspNetCore.Mvc.Controller.TempData>.</span></span> <span data-ttu-id="d3cce-495">Cette propriété stocke les données jusqu’à ce qu’elles soient lues dans une autre requête.</span><span class="sxs-lookup"><span data-stu-id="d3cce-495">This property stores data until it's read in another request.</span></span> <span data-ttu-id="d3cce-496">Les méthodes [Keep (String)](xref:Microsoft.AspNetCore.Mvc.ViewFeatures.ITempDataDictionary.Keep*) et [Peek (String)](xref:Microsoft.AspNetCore.Mvc.ViewFeatures.ITempDataDictionary.Peek*) peuvent être utilisées pour examiner les données sans suppression à la fin de la requête.</span><span class="sxs-lookup"><span data-stu-id="d3cce-496">[Keep(String)](xref:Microsoft.AspNetCore.Mvc.ViewFeatures.ITempDataDictionary.Keep*) and [Peek(string)](xref:Microsoft.AspNetCore.Mvc.ViewFeatures.ITempDataDictionary.Peek*) methods can be used to examine the data without deletion at the end of the request.</span></span> <span data-ttu-id="d3cce-497">[Keep ()](xref:Microsoft.AspNetCore.Mvc.ViewFeatures.ITempDataDictionary.Keep*) marque tous les éléments du dictionnaire pour la rétention.</span><span class="sxs-lookup"><span data-stu-id="d3cce-497">[Keep()](xref:Microsoft.AspNetCore.Mvc.ViewFeatures.ITempDataDictionary.Keep*) marks all items in the dictionary for retention.</span></span> <span data-ttu-id="d3cce-498">`TempData` est particulièrement utile pour la redirection quand des données sont requises pour plus d’une requête unique.</span><span class="sxs-lookup"><span data-stu-id="d3cce-498">`TempData` is particularly useful for redirection when data is required for more than a single request.</span></span> <span data-ttu-id="d3cce-499">`TempData` est implémenté par les `TempData` fournisseurs à l’aide de ou de l' cookie État de session.</span><span class="sxs-lookup"><span data-stu-id="d3cce-499">`TempData` is implemented by `TempData` providers using either cookies or session state.</span></span>

## <a name="tempdata-samples"></a><span data-ttu-id="d3cce-500">Exemples TempData</span><span class="sxs-lookup"><span data-stu-id="d3cce-500">TempData samples</span></span>

<span data-ttu-id="d3cce-501">Examinez la page suivante qui crée un client :</span><span class="sxs-lookup"><span data-stu-id="d3cce-501">Consider the following page that creates a customer:</span></span>

[!code-csharp[](app-state/3.0samples/RazorPagesContacts/Pages/Customers/Create.cshtml.cs?name=snippet&highlight=15-16,30)]

<span data-ttu-id="d3cce-502">La page suivante affiche `TempData["Message"]` :</span><span class="sxs-lookup"><span data-stu-id="d3cce-502">The following page displays `TempData["Message"]`:</span></span>

[!code-cshtml[](app-state/3.0samples/RazorPagesContacts/Pages/Customers/IndexPeek.cshtml?range=1-14)]

<span data-ttu-id="d3cce-503">Dans le balisage précédent, à la fin de la demande, `TempData["Message"]` n’est **pas** supprimé, car `Peek` est utilisé.</span><span class="sxs-lookup"><span data-stu-id="d3cce-503">In the preceding markup, at the end of the request, `TempData["Message"]` is **not** deleted because `Peek` is used.</span></span> <span data-ttu-id="d3cce-504">L’actualisation de la page s’affiche `TempData["Message"]` .</span><span class="sxs-lookup"><span data-stu-id="d3cce-504">Refreshing the page displays `TempData["Message"]`.</span></span>

<span data-ttu-id="d3cce-505">Le balisage suivant est semblable au code précédent, mais utilise `Keep` pour conserver les données à la fin de la requête :</span><span class="sxs-lookup"><span data-stu-id="d3cce-505">The following markup is similar to the preceding code, but uses `Keep` to preserve the data at the end of the request:</span></span>

[!code-cshtml[](app-state/3.0samples/RazorPagesContacts/Pages/Customers/IndexKeep.cshtml?range=1-14)]

<span data-ttu-id="d3cce-506">La navigation entre les pages *IndexPeek* et *IndexKeep* ne sera pas supprimée `TempData["Message"]` .</span><span class="sxs-lookup"><span data-stu-id="d3cce-506">Navigating between the *IndexPeek* and *IndexKeep* pages won't delete `TempData["Message"]`.</span></span>

<span data-ttu-id="d3cce-507">Le code suivant affiche `TempData["Message"]` , mais à la fin de la demande, `TempData["Message"]` est supprimé :</span><span class="sxs-lookup"><span data-stu-id="d3cce-507">The following code displays `TempData["Message"]`, but at the end of the request, `TempData["Message"]` is deleted:</span></span>

[!code-cshtml[](app-state/3.0samples/RazorPagesContacts/Pages/Customers/Index.cshtml?range=1-14)]

### <a name="tempdata-providers"></a><span data-ttu-id="d3cce-508">Fournisseurs TempData</span><span class="sxs-lookup"><span data-stu-id="d3cce-508">TempData providers</span></span>

<span data-ttu-id="d3cce-509">Le cookie fournisseur TempData basé sur utilise par défaut pour stocker TempData dans cookie s.</span><span class="sxs-lookup"><span data-stu-id="d3cce-509">The cookie-based TempData provider is used by default to store TempData in cookies.</span></span>

<span data-ttu-id="d3cce-510">Les cookie données sont chiffrées à l’aide de <xref:Microsoft.AspNetCore.DataProtection.IDataProtector> , encodées avec <xref:Microsoft.AspNetCore.WebUtilities.Base64UrlTextEncoder> , puis segmentées.</span><span class="sxs-lookup"><span data-stu-id="d3cce-510">The cookie data is encrypted using <xref:Microsoft.AspNetCore.DataProtection.IDataProtector>, encoded with <xref:Microsoft.AspNetCore.WebUtilities.Base64UrlTextEncoder>, then chunked.</span></span> <span data-ttu-id="d3cce-511">Étant donné que le cookie est segmenté, la cookie limite de taille unique trouvée dans ASP.net Core 1. x ne s’applique pas.</span><span class="sxs-lookup"><span data-stu-id="d3cce-511">Because the cookie is chunked, the single cookie size limit found in ASP.NET Core 1.x doesn't apply.</span></span> <span data-ttu-id="d3cce-512">Les cookie données ne sont pas compressées, car la compression des données chiffrées peut entraîner des problèmes de sécurité tels que les attaques de [criminalité](https://wikipedia.org/wiki/CRIME_(security_exploit)) et de [violation](https://wikipedia.org/wiki/BREACH_(security_exploit)) .</span><span class="sxs-lookup"><span data-stu-id="d3cce-512">The cookie data isn't compressed because compressing encrypted data can lead to security problems such as the [CRIME](https://wikipedia.org/wiki/CRIME_(security_exploit)) and [BREACH](https://wikipedia.org/wiki/BREACH_(security_exploit)) attacks.</span></span> <span data-ttu-id="d3cce-513">Pour plus d’informations sur le cookie fournisseur TempData basé sur, consultez <xref:Microsoft.AspNetCore.Mvc.ViewFeatures.CookieTempDataProvider> .</span><span class="sxs-lookup"><span data-stu-id="d3cce-513">For more information on the cookie-based TempData provider, see <xref:Microsoft.AspNetCore.Mvc.ViewFeatures.CookieTempDataProvider>.</span></span>

### <a name="choose-a-tempdata-provider"></a><span data-ttu-id="d3cce-514">Choisir un fournisseur TempData</span><span class="sxs-lookup"><span data-stu-id="d3cce-514">Choose a TempData provider</span></span>

<span data-ttu-id="d3cce-515">Pour choisir un fournisseur TempData, vous devez tenir compte de plusieurs points. Par exemple :</span><span class="sxs-lookup"><span data-stu-id="d3cce-515">Choosing a TempData provider involves several considerations, such as:</span></span>

1. <span data-ttu-id="d3cce-516">L’application utilise-t-elle déjà l’état de session ?</span><span class="sxs-lookup"><span data-stu-id="d3cce-516">Does the app already use session state?</span></span> <span data-ttu-id="d3cce-517">Si c’est le cas, l’utilisation du fournisseur TempData d’état de session n’entraîne pas de surcoût pour l’application (hormis la taille des données).</span><span class="sxs-lookup"><span data-stu-id="d3cce-517">If so, using the session state TempData provider has no additional cost to the app (aside from the size of the data).</span></span>
2. <span data-ttu-id="d3cce-518">L’application utilise-t-elle TempData seulement de façon ponctuelle, pour des quantités de données relativement petites (jusqu’à 500 octets) ?</span><span class="sxs-lookup"><span data-stu-id="d3cce-518">Does the app use TempData only sparingly for relatively small amounts of data (up to 500 bytes)?</span></span> <span data-ttu-id="d3cce-519">Si c’est le cas, le cookie fournisseur TempData ajoute un coût réduit à chaque demande qui transporte TempData.</span><span class="sxs-lookup"><span data-stu-id="d3cce-519">If so, the cookie TempData provider adds a small cost to each request that carries TempData.</span></span> <span data-ttu-id="d3cce-520">Si ce n’est pas le cas, le fournisseur TempData d’état de session peut être utile pour éviter l’aller-retour d’une grande quantité de données dans chaque requête jusqu’à ce que le TempData soit consommé.</span><span class="sxs-lookup"><span data-stu-id="d3cce-520">If not, the session state TempData provider can be beneficial to avoid round-tripping a large amount of data in each request until the TempData is consumed.</span></span>
3. <span data-ttu-id="d3cce-521">L’application s’exécute-t-elle dans une batterie de serveurs sur plusieurs serveurs ?</span><span class="sxs-lookup"><span data-stu-id="d3cce-521">Does the app run in a server farm on multiple servers?</span></span> <span data-ttu-id="d3cce-522">Dans ce cas, aucune configuration supplémentaire n’est requise pour utiliser le cookie fournisseur TempData en dehors de la protection des données (voir <xref:security/data-protection/introduction> et [fournisseurs de stockage de clés](xref:security/data-protection/implementation/key-storage-providers)).</span><span class="sxs-lookup"><span data-stu-id="d3cce-522">If so, there's no additional configuration required to use the cookie TempData provider outside of Data Protection (see <xref:security/data-protection/introduction> and [Key storage providers](xref:security/data-protection/implementation/key-storage-providers)).</span></span>

> [!NOTE]
> <span data-ttu-id="d3cce-523">La plupart des clients Web (tels que les navigateurs Web) appliquent des limites sur la taille maximale de chaque cookie , le nombre total de ou cookie les deux.</span><span class="sxs-lookup"><span data-stu-id="d3cce-523">Most web clients (such as web browsers) enforce limits on the maximum size of each cookie, the total number of cookies, or both.</span></span> <span data-ttu-id="d3cce-524">Lorsque vous utilisez le cookie fournisseur TempData, vérifiez que l’application ne dépasse pas ces limites.</span><span class="sxs-lookup"><span data-stu-id="d3cce-524">When using the cookie TempData provider, verify the app won't exceed these limits.</span></span> <span data-ttu-id="d3cce-525">Prenez en compte la taille totale des données.</span><span class="sxs-lookup"><span data-stu-id="d3cce-525">Consider the total size of the data.</span></span> <span data-ttu-id="d3cce-526">Compte de augmentation de la cookie taille en raison du chiffrement et de la segmentation.</span><span class="sxs-lookup"><span data-stu-id="d3cce-526">Account for increases in cookie size due to encryption and chunking.</span></span>

### <a name="configure-the-tempdata-provider"></a><span data-ttu-id="d3cce-527">Configuration du fournisseur TempData</span><span class="sxs-lookup"><span data-stu-id="d3cce-527">Configure the TempData provider</span></span>

<span data-ttu-id="d3cce-528">Le cookie fournisseur TempData basé sur est activé par défaut.</span><span class="sxs-lookup"><span data-stu-id="d3cce-528">The cookie-based TempData provider is enabled by default.</span></span>

<span data-ttu-id="d3cce-529">Pour activer le fournisseur TempData basé sur une session, utilisez la <xref:Microsoft.Extensions.DependencyInjection.MvcViewFeaturesMvcBuilderExtensions.AddSessionStateTempDataProvider%2A> méthode d’extension :</span><span class="sxs-lookup"><span data-stu-id="d3cce-529">To enable the session-based TempData provider, use the <xref:Microsoft.Extensions.DependencyInjection.MvcViewFeaturesMvcBuilderExtensions.AddSessionStateTempDataProvider%2A> extension method:</span></span>

[!code-csharp[](app-state/samples_snapshot_2/2.x/SessionSample/Startup.cs?name=snippet1&highlight=11,13,32)]

<span data-ttu-id="d3cce-530">L’ordre des middlewares est important.</span><span class="sxs-lookup"><span data-stu-id="d3cce-530">The order of middleware is important.</span></span> <span data-ttu-id="d3cce-531">Dans l’exemple précédent, une exception `InvalidOperationException` se produit quand `UseSession` est appelée après `UseMvc`.</span><span class="sxs-lookup"><span data-stu-id="d3cce-531">In the preceding example, an `InvalidOperationException` exception occurs when `UseSession` is invoked after `UseMvc`.</span></span> <span data-ttu-id="d3cce-532">Pour plus d’informations, consultez [Ordre des intergiciels (middleware)](xref:fundamentals/middleware/index#order).</span><span class="sxs-lookup"><span data-stu-id="d3cce-532">For more information, see [Middleware Ordering](xref:fundamentals/middleware/index#order).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="d3cce-533">Si vous ciblez le .NET Framework et que vous utilisez le fournisseur TempData basé sur la session, ajoutez le package [Microsoft.AspNetCore.Session](https://www.nuget.org/packages/Microsoft.AspNetCore.Session/) au projet.</span><span class="sxs-lookup"><span data-stu-id="d3cce-533">If targeting .NET Framework and using the session-based TempData provider, add the [Microsoft.AspNetCore.Session](https://www.nuget.org/packages/Microsoft.AspNetCore.Session/) package to the project.</span></span>

## <a name="query-strings"></a><span data-ttu-id="d3cce-534">Chaînes de requête</span><span class="sxs-lookup"><span data-stu-id="d3cce-534">Query strings</span></span>

<span data-ttu-id="d3cce-535">Vous pouvez passer une quantité limitée de données d’une requête à une autre en l’ajoutant à la chaîne de la nouvelle requête.</span><span class="sxs-lookup"><span data-stu-id="d3cce-535">A limited amount of data can be passed from one request to another by adding it to the new request's query string.</span></span> <span data-ttu-id="d3cce-536">Cela est utile pour capturer l’état de manière persistante et permettre ainsi le partage de liens avec état incorporé par e-mail ou sur les réseaux sociaux.</span><span class="sxs-lookup"><span data-stu-id="d3cce-536">This is useful for capturing state in a persistent manner that allows links with embedded state to be shared through email or social networks.</span></span> <span data-ttu-id="d3cce-537">Les chaînes de requête URL étant publiques, vous ne devez jamais utiliser de chaînes de requête pour des données sensibles.</span><span class="sxs-lookup"><span data-stu-id="d3cce-537">Because URL query strings are public, never use query strings for sensitive data.</span></span>

<span data-ttu-id="d3cce-538">En plus du partage accidentel, l’ajout de données dans des chaînes de requête peut favoriser les attaques par [falsification de requête intersites (CSRF, Cross Site Request Forgery)](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)) et conduire des utilisateurs authentifiés à visiter des sites malveillants.</span><span class="sxs-lookup"><span data-stu-id="d3cce-538">In addition to unintended sharing, including data in query strings can create opportunities for [Cross-Site Request Forgery (CSRF)](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)) attacks, which can trick users into visiting malicious sites while authenticated.</span></span> <span data-ttu-id="d3cce-539">Les attaquants peuvent ensuite dérober des données utilisateur à partir de l’application ou effectuer des actions malveillantes en utilisant un compte d’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="d3cce-539">Attackers can then steal user data from the app or take malicious actions on behalf of the user.</span></span> <span data-ttu-id="d3cce-540">Chaque état de session ou d’application conservé doit garantir une protection contre les attaques CSRF.</span><span class="sxs-lookup"><span data-stu-id="d3cce-540">Any preserved app or session state must protect against CSRF attacks.</span></span> <span data-ttu-id="d3cce-541">Pour plus d'informations, consultez <xref:security/anti-request-forgery>.</span><span class="sxs-lookup"><span data-stu-id="d3cce-541">For more information, see <xref:security/anti-request-forgery>.</span></span>

## <a name="hidden-fields"></a><span data-ttu-id="d3cce-542">Champs masqués</span><span class="sxs-lookup"><span data-stu-id="d3cce-542">Hidden fields</span></span>

<span data-ttu-id="d3cce-543">Les données peuvent être enregistrées dans des champs de formulaire masqués et être republiées lors de la requête suivante.</span><span class="sxs-lookup"><span data-stu-id="d3cce-543">Data can be saved in hidden form fields and posted back on the next request.</span></span> <span data-ttu-id="d3cce-544">Cela est courant dans les formulaires de plusieurs pages.</span><span class="sxs-lookup"><span data-stu-id="d3cce-544">This is common in multi-page forms.</span></span> <span data-ttu-id="d3cce-545">Étant donné que le client peut potentiellement falsifier les données, l’application doit toujours revalider les données stockées dans les champs masqués.</span><span class="sxs-lookup"><span data-stu-id="d3cce-545">Because the client can potentially tamper with the data, the app must always revalidate the data stored in hidden fields.</span></span>

## <a name="httpcontextitems"></a><span data-ttu-id="d3cce-546">HttpContext.Items</span><span class="sxs-lookup"><span data-stu-id="d3cce-546">HttpContext.Items</span></span>

<span data-ttu-id="d3cce-547">La <xref:Microsoft.AspNetCore.Http.HttpContext.Items?displayProperty=nameWithType> collection est utilisée pour stocker des données lors du traitement d’une requête unique.</span><span class="sxs-lookup"><span data-stu-id="d3cce-547">The <xref:Microsoft.AspNetCore.Http.HttpContext.Items?displayProperty=nameWithType> collection is used to store data while processing a single request.</span></span> <span data-ttu-id="d3cce-548">Le contenu de la collection est supprimé une fois la requête traitée.</span><span class="sxs-lookup"><span data-stu-id="d3cce-548">The collection's contents are discarded after a request is processed.</span></span> <span data-ttu-id="d3cce-549">La collection `Items` est souvent utilisée pour permettre à des composants ou des middlewares de communiquer quand ils opèrent à différents moments de l’exécution d’une requête et qu’ils ne peuvent pas passer les paramètres de façon directe.</span><span class="sxs-lookup"><span data-stu-id="d3cce-549">The `Items` collection is often used to allow components or middleware to communicate when they operate at different points in time during a request and have no direct way to pass parameters.</span></span>

<span data-ttu-id="d3cce-550">Dans l’exemple suivant, le [middleware](xref:fundamentals/middleware/index) ajoute `isVerified` à la collection `Items`.</span><span class="sxs-lookup"><span data-stu-id="d3cce-550">In the following example, [middleware](xref:fundamentals/middleware/index) adds `isVerified` to the `Items` collection.</span></span>

```csharp
app.Use(async (context, next) =>
{
    // perform some verification
    context.Items["isVerified"] = true;
    await next.Invoke();
});
```

<span data-ttu-id="d3cce-551">Plus tard dans le pipeline, un autre middleware peut accéder à la valeur de `isVerified` :</span><span class="sxs-lookup"><span data-stu-id="d3cce-551">Later in the pipeline, another middleware can access the value of `isVerified`:</span></span>

```csharp
app.Run(async (context) =>
{
    await context.Response.WriteAsync($"Verified: {context.Items["isVerified"]}");
});
```

<span data-ttu-id="d3cce-552">Si un middleware est destiné uniquement à l’usage d’une seule application, les clés `string` sont acceptables.</span><span class="sxs-lookup"><span data-stu-id="d3cce-552">For middleware that's only used by a single app, `string` keys are acceptable.</span></span> <span data-ttu-id="d3cce-553">Le middleware partagé entre des instances de l’application doit utiliser des clés d’objets uniques afin d’éviter les conflits de clé.</span><span class="sxs-lookup"><span data-stu-id="d3cce-553">Middleware shared between app instances should use unique object keys to avoid key collisions.</span></span> <span data-ttu-id="d3cce-554">L’exemple suivant montre comment utiliser une clé d’objet unique définie dans une classe de middleware :</span><span class="sxs-lookup"><span data-stu-id="d3cce-554">The following example shows how to use a unique object key defined in a middleware class:</span></span>

[!code-csharp[](app-state/samples/2.x/SessionSample/Middleware/HttpContextItemsMiddleware.cs?name=snippet1&highlight=4,13)]

<span data-ttu-id="d3cce-555">Tout autre code peut accéder à la valeur stockée dans `HttpContext.Items` à l’aide de la clé exposée par la classe du middleware :</span><span class="sxs-lookup"><span data-stu-id="d3cce-555">Other code can access the value stored in `HttpContext.Items` using the key exposed by the middleware class:</span></span>

[!code-csharp[](app-state/samples/2.x/SessionSample/Pages/Index.cshtml.cs?name=snippet3)]

<span data-ttu-id="d3cce-556">Cette approche a également l’avantage d’éliminer l’utilisation des chaînes de clés dans le code.</span><span class="sxs-lookup"><span data-stu-id="d3cce-556">This approach also has the advantage of eliminating the use of key strings in the code.</span></span>

## <a name="cache"></a><span data-ttu-id="d3cce-557">d'instance/de clé</span><span class="sxs-lookup"><span data-stu-id="d3cce-557">Cache</span></span>

<span data-ttu-id="d3cce-558">La mise en cache est un moyen efficace de stocker et récupérer des données.</span><span class="sxs-lookup"><span data-stu-id="d3cce-558">Caching is an efficient way to store and retrieve data.</span></span> <span data-ttu-id="d3cce-559">L’application peut contrôler la durée de vie des éléments mis en cache.</span><span class="sxs-lookup"><span data-stu-id="d3cce-559">The app can control the lifetime of cached items.</span></span>

<span data-ttu-id="d3cce-560">Les données mises en cache ne sont pas associées à une requête, un utilisateur ou une session spécifique.</span><span class="sxs-lookup"><span data-stu-id="d3cce-560">Cached data isn't associated with a specific request, user, or session.</span></span> <span data-ttu-id="d3cce-561">**Veillez à ne pas mettre en cache des données propres à l’utilisateur susceptibles d’être récupérées par les requêtes d’autres utilisateurs.**</span><span class="sxs-lookup"><span data-stu-id="d3cce-561">**Be careful not to cache user-specific data that may be retrieved by other users' requests.**</span></span>

<span data-ttu-id="d3cce-562">Pour plus d'informations, consultez <xref:performance/caching/response>.</span><span class="sxs-lookup"><span data-stu-id="d3cce-562">For more information, see <xref:performance/caching/response>.</span></span>

## <a name="dependency-injection"></a><span data-ttu-id="d3cce-563">Injection de dépendances</span><span class="sxs-lookup"><span data-stu-id="d3cce-563">Dependency Injection</span></span>

<span data-ttu-id="d3cce-564">Utilisez [l’injection de dépendances](xref:fundamentals/dependency-injection) pour rendre les données accessibles à tous les utilisateurs :</span><span class="sxs-lookup"><span data-stu-id="d3cce-564">Use [Dependency Injection](xref:fundamentals/dependency-injection) to make data available to all users:</span></span>

1. <span data-ttu-id="d3cce-565">Définissez un service contenant les données.</span><span class="sxs-lookup"><span data-stu-id="d3cce-565">Define a service containing the data.</span></span> <span data-ttu-id="d3cce-566">Par exemple, une classe nommée `MyAppData` est définie :</span><span class="sxs-lookup"><span data-stu-id="d3cce-566">For example, a class named `MyAppData` is defined:</span></span>

    ```csharp
    public class MyAppData
    {
        // Declare properties and methods
    }
    ```

2. <span data-ttu-id="d3cce-567">Ajoutez la classe de service à `Startup.ConfigureServices` :</span><span class="sxs-lookup"><span data-stu-id="d3cce-567">Add the service class to `Startup.ConfigureServices`:</span></span>

    ```csharp
    public void ConfigureServices(IServiceCollection services)
    {
        services.AddSingleton<MyAppData>();
    }
    ```

3. <span data-ttu-id="d3cce-568">Consommez la classe de service de données :</span><span class="sxs-lookup"><span data-stu-id="d3cce-568">Consume the data service class:</span></span>

    ```csharp
    public class IndexModel : PageModel
    {
        public IndexModel(MyAppData myService)
        {
            // Do something with the service
            //    Examples: Read data, store in a field or property
        }
    }
    ```

## <a name="common-errors"></a><span data-ttu-id="d3cce-569">Erreurs courantes</span><span class="sxs-lookup"><span data-stu-id="d3cce-569">Common errors</span></span>

* <span data-ttu-id="d3cce-570">« Impossible de résoudre le service pour le type 'Microsoft.Extensions.Caching.Distributed.IDistributedCache' lors de la tentative d’activation de 'Microsoft.AspNetCore.Session.DistributedSessionStore'. »</span><span class="sxs-lookup"><span data-stu-id="d3cce-570">"Unable to resolve service for type 'Microsoft.Extensions.Caching.Distributed.IDistributedCache' while attempting to activate 'Microsoft.AspNetCore.Session.DistributedSessionStore'."</span></span>

  <span data-ttu-id="d3cce-571">Cette erreur est généralement due à un échec de configuration d’au moins une implémentation `IDistributedCache`.</span><span class="sxs-lookup"><span data-stu-id="d3cce-571">This is usually caused by failing to configure at least one `IDistributedCache` implementation.</span></span> <span data-ttu-id="d3cce-572">Pour plus d’informations, consultez <xref:performance/caching/distributed> et <xref:performance/caching/memory>.</span><span class="sxs-lookup"><span data-stu-id="d3cce-572">For more information, see <xref:performance/caching/distributed> and <xref:performance/caching/memory>.</span></span>

* <span data-ttu-id="d3cce-573">Dans le cas où le middleware Session ne parvient pas à rendre une session persistante (par exemple si le magasin de stockage n’est pas disponible), il enregistre l’exception dans le journal et la requête se poursuit normalement.</span><span class="sxs-lookup"><span data-stu-id="d3cce-573">In the event that the session middleware fails to persist a session (for example, if the backing store isn't available), the middleware logs the exception and the request continues normally.</span></span> <span data-ttu-id="d3cce-574">Cela entraîne un comportement imprévisible.</span><span class="sxs-lookup"><span data-stu-id="d3cce-574">This leads to unpredictable behavior.</span></span>

  <span data-ttu-id="d3cce-575">Par exemple, imaginez qu’un utilisateur stocke un panier d’achat dans la session.</span><span class="sxs-lookup"><span data-stu-id="d3cce-575">For example, a user stores a shopping cart in session.</span></span> <span data-ttu-id="d3cce-576">Il ajoute un élément au panier, mais la validation échoue.</span><span class="sxs-lookup"><span data-stu-id="d3cce-576">The user adds an item to the cart but the commit fails.</span></span> <span data-ttu-id="d3cce-577">L’application n’a pas connaissance de l’échec et signale donc à l’utilisateur que l’élément a été ajouté au panier, ce qui est faux.</span><span class="sxs-lookup"><span data-stu-id="d3cce-577">The app doesn't know about the failure so it reports to the user that the item was added to their cart, which isn't true.</span></span>

  <span data-ttu-id="d3cce-578">L’approche recommandée pour rechercher les erreurs de ce type consiste à appeler `await feature.Session.CommitAsync();` à partir du code d’application quand l’application a terminé d’écrire dans la session.</span><span class="sxs-lookup"><span data-stu-id="d3cce-578">The recommended approach to check for errors is to call `await feature.Session.CommitAsync();` from app code when the app is done writing to the session.</span></span> <span data-ttu-id="d3cce-579">`CommitAsync` lève une exception si le magasin de stockage n’est pas disponible.</span><span class="sxs-lookup"><span data-stu-id="d3cce-579">`CommitAsync` throws an exception if the backing store is unavailable.</span></span> <span data-ttu-id="d3cce-580">Si `CommitAsync` échoue, l’application peut traiter l’exception.</span><span class="sxs-lookup"><span data-stu-id="d3cce-580">If `CommitAsync` fails, the app can process the exception.</span></span> <span data-ttu-id="d3cce-581">`LoadAsync` lève une exception dans les mêmes conditions, quand le magasin de données n’est pas disponible.</span><span class="sxs-lookup"><span data-stu-id="d3cce-581">`LoadAsync` throws under the same conditions where the data store is unavailable.</span></span>
  
## <a name="no-locsignalr-and-session-state"></a><span data-ttu-id="d3cce-582">SignalR et état de session</span><span class="sxs-lookup"><span data-stu-id="d3cce-582">SignalR and session state</span></span>

<span data-ttu-id="d3cce-583">SignalR les applications ne doivent pas utiliser l’état de session pour stocker des informations.</span><span class="sxs-lookup"><span data-stu-id="d3cce-583">SignalR apps should not use session state to store information.</span></span> <span data-ttu-id="d3cce-584">SignalR les applications peuvent stocker par État de connexion dans `Context.Items` le Hub.</span><span class="sxs-lookup"><span data-stu-id="d3cce-584">SignalR apps can store per connection state in `Context.Items` in the hub.</span></span> <!-- https://github.com/aspnet/SignalR/issues/2139 -->

## <a name="additional-resources"></a><span data-ttu-id="d3cce-585">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="d3cce-585">Additional resources</span></span>

<xref:host-and-deploy/web-farm>
::: moniker-end
