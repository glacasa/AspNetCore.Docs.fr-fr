---
title: Gestion et durée de vie des clés de protection des données dans ASP.NET Core
author: rick-anderson
description: En savoir plus sur la gestion et la durée de vie des clés de protection des données dans ASP.NET Core.
ms.author: riande
ms.date: 10/14/2016
no-loc:
- ASP.NET Core Identity
- cookie
- Cookie
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: security/data-protection/configuration/default-settings
ms.openlocfilehash: b4578737a0ea36463b3c44254aad85a484c46090
ms.sourcegitcommit: 65add17f74a29a647d812b04517e46cbc78258f9
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/19/2020
ms.locfileid: "88634473"
---
# <a name="data-protection-key-management-and-lifetime-in-aspnet-core"></a><span data-ttu-id="d201a-103">Gestion et durée de vie des clés de protection des données dans ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="d201a-103">Data Protection key management and lifetime in ASP.NET Core</span></span>

<span data-ttu-id="d201a-104">Par [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="d201a-104">By [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

## <a name="key-management"></a><span data-ttu-id="d201a-105">Gestion des clés</span><span class="sxs-lookup"><span data-stu-id="d201a-105">Key management</span></span>

<span data-ttu-id="d201a-106">L’application tente de détecter son environnement d’exploitation et de gérer la configuration de clé proprement dit.</span><span class="sxs-lookup"><span data-stu-id="d201a-106">The app attempts to detect its operational environment and handle key configuration on its own.</span></span>

1. <span data-ttu-id="d201a-107">Si l’application est hébergée dans des [applications Azure](https://azure.microsoft.com/services/app-service/), les clés sont conservées dans le dossier *%Home%\ASP.NET\DataProtection-Keys* .</span><span class="sxs-lookup"><span data-stu-id="d201a-107">If the app is hosted in [Azure Apps](https://azure.microsoft.com/services/app-service/), keys are persisted to the *%HOME%\ASP.NET\DataProtection-Keys* folder.</span></span> <span data-ttu-id="d201a-108">Ce dossier est alimenté par le stockage réseau et synchronisé sur tous les ordinateurs hébergeant l’application.</span><span class="sxs-lookup"><span data-stu-id="d201a-108">This folder is backed by network storage and is synchronized across all machines hosting the app.</span></span>
   * <span data-ttu-id="d201a-109">Les clés ne sont pas protégées au repos.</span><span class="sxs-lookup"><span data-stu-id="d201a-109">Keys aren't protected at rest.</span></span>
   * <span data-ttu-id="d201a-110">Le dossier *dataprotection-Keys* fournit l’anneau clé à toutes les instances d’une application dans un seul emplacement de déploiement.</span><span class="sxs-lookup"><span data-stu-id="d201a-110">The *DataProtection-Keys* folder supplies the key ring to all instances of an app in a single deployment slot.</span></span>
   * <span data-ttu-id="d201a-111">Les emplacements de déploiement distincts, tels que Préproduction et Production, ne partagent pas de porte-clés.</span><span class="sxs-lookup"><span data-stu-id="d201a-111">Separate deployment slots, such as Staging and Production, don't share a key ring.</span></span> <span data-ttu-id="d201a-112">Lorsque vous basculez entre les emplacements de déploiement, par exemple en échange de la mise en lots vers la production ou à l’aide d’un test A/B, toute application utilisant la protection des données ne pourra pas déchiffrer les données stockées à l’aide de l’anneau de clé à l’intérieur de l’emplacement précédent.</span><span class="sxs-lookup"><span data-stu-id="d201a-112">When you swap between deployment slots, for example swapping Staging to Production or using A/B testing, any app using Data Protection won't be able to decrypt stored data using the key ring inside the previous slot.</span></span> <span data-ttu-id="d201a-113">Cela amène les utilisateurs à se déconnecter d’une application qui utilise l’authentification ASP.NET Core standard cookie , car elle utilise la protection des données pour protéger ses cookie s.</span><span class="sxs-lookup"><span data-stu-id="d201a-113">This leads to users being logged out of an app that uses the standard ASP.NET Core cookie authentication, as it uses Data Protection to protect its cookies.</span></span> <span data-ttu-id="d201a-114">Si vous souhaitez des sonneries de clé indépendantes du logement, utilisez un fournisseur de sonneries de clé externe, tel que le stockage d’objets BLOB Azure, Azure Key Vault, un magasin SQL ou un cache ReDim.</span><span class="sxs-lookup"><span data-stu-id="d201a-114">If you desire slot-independent key rings, use an external key ring provider, such as Azure Blob Storage, Azure Key Vault, a SQL store, or Redis cache.</span></span>

1. <span data-ttu-id="d201a-115">Si le profil utilisateur est disponible, les clés sont conservées dans le dossier *%LocalAppData%\ASP.NET\DataProtection-Keys* .</span><span class="sxs-lookup"><span data-stu-id="d201a-115">If the user profile is available, keys are persisted to the *%LOCALAPPDATA%\ASP.NET\DataProtection-Keys* folder.</span></span> <span data-ttu-id="d201a-116">Si le système d’exploitation est Windows, les clés sont chiffrées au repos à l’aide de DPAPI.</span><span class="sxs-lookup"><span data-stu-id="d201a-116">If the operating system is Windows, the keys are encrypted at rest using DPAPI.</span></span>

   <span data-ttu-id="d201a-117">L’[attribut setProfileEnvironment](/iis/configuration/system.applicationhost/applicationpools/add/processmodel#configuration) du pool d’applications doit également être activé.</span><span class="sxs-lookup"><span data-stu-id="d201a-117">The app pool's [setProfileEnvironment attribute](/iis/configuration/system.applicationhost/applicationpools/add/processmodel#configuration) must also be enabled.</span></span> <span data-ttu-id="d201a-118">La valeur par défaut de `setProfileEnvironment` est `true`.</span><span class="sxs-lookup"><span data-stu-id="d201a-118">The default value of `setProfileEnvironment` is `true`.</span></span> <span data-ttu-id="d201a-119">Dans certains scénarios (par exemple pour le système d’exploitation Windows), `setProfileEnvironment` est défini sur `false`.</span><span class="sxs-lookup"><span data-stu-id="d201a-119">In some scenarios (for example, Windows OS), `setProfileEnvironment` is set to `false`.</span></span> <span data-ttu-id="d201a-120">Si les clés ne sont pas stockées dans le répertoire de profil utilisateur comme prévu :</span><span class="sxs-lookup"><span data-stu-id="d201a-120">If keys aren't stored in the user profile directory as expected:</span></span>

   1. <span data-ttu-id="d201a-121">Accédez au dossier *%windir%/system32/inetsrv/config*.</span><span class="sxs-lookup"><span data-stu-id="d201a-121">Navigate to the *%windir%/system32/inetsrv/config* folder.</span></span>
   1. <span data-ttu-id="d201a-122">Ouvrez le fichier *applicationHost.config*.</span><span class="sxs-lookup"><span data-stu-id="d201a-122">Open the *applicationHost.config* file.</span></span>
   1. <span data-ttu-id="d201a-123">Recherchez l’élément `<system.applicationHost><applicationPools><applicationPoolDefaults><processModel>`.</span><span class="sxs-lookup"><span data-stu-id="d201a-123">Locate the `<system.applicationHost><applicationPools><applicationPoolDefaults><processModel>` element.</span></span>
   1. <span data-ttu-id="d201a-124">Confirmez que l’attribut `setProfileEnvironment` n’est pas présent, ce qui implique que la valeur par défaut est `true`, ou définissez de manière explicite la valeur de l’attribut sur `true`.</span><span class="sxs-lookup"><span data-stu-id="d201a-124">Confirm that the `setProfileEnvironment` attribute isn't present, which defaults the value to `true`, or explicitly set the attribute's value to `true`.</span></span>

1. <span data-ttu-id="d201a-125">Si l’application est hébergée dans IIS, les clés sont conservées dans le Registre HKLM dans une clé de Registre spéciale qui est gérée uniquement au compte du processus de travail.</span><span class="sxs-lookup"><span data-stu-id="d201a-125">If the app is hosted in IIS, keys are persisted to the HKLM registry in a special registry key that's ACLed only to the worker process account.</span></span> <span data-ttu-id="d201a-126">Les clés sont chiffrées au repos à l’aide de DPAPI.</span><span class="sxs-lookup"><span data-stu-id="d201a-126">Keys are encrypted at rest using DPAPI.</span></span>

1. <span data-ttu-id="d201a-127">Si aucune de ces conditions ne correspond, les clés ne sont pas conservées en dehors du processus en cours.</span><span class="sxs-lookup"><span data-stu-id="d201a-127">If none of these conditions match, keys aren't persisted outside of the current process.</span></span> <span data-ttu-id="d201a-128">Lorsque le processus s’arrête, toutes les clés générées sont perdues.</span><span class="sxs-lookup"><span data-stu-id="d201a-128">When the process shuts down, all generated keys are lost.</span></span>

<span data-ttu-id="d201a-129">Le développeur est toujours en contrôle total et peut remplacer le mode et l’emplacement de stockage des clés.</span><span class="sxs-lookup"><span data-stu-id="d201a-129">The developer is always in full control and can override how and where keys are stored.</span></span> <span data-ttu-id="d201a-130">Les trois premières options ci-dessus doivent fournir des valeurs par défaut appropriées pour la plupart des applications similaires à la façon dont les **\<machineKey>** routines de génération automatique ASP.net fonctionnaient dans le passé.</span><span class="sxs-lookup"><span data-stu-id="d201a-130">The first three options above should provide good defaults for most apps similar to how the ASP.NET **\<machineKey>** auto-generation routines worked in the past.</span></span> <span data-ttu-id="d201a-131">L’option de secours finale est le seul scénario qui requiert que le développeur spécifie la [configuration](xref:security/data-protection/configuration/overview) avant s’il souhaite une persistance des clés, mais ce secours ne se produit que dans de rares cas.</span><span class="sxs-lookup"><span data-stu-id="d201a-131">The final, fallback option is the only scenario that requires the developer to specify [configuration](xref:security/data-protection/configuration/overview) upfront if they want key persistence, but this fallback only occurs in rare situations.</span></span>

<span data-ttu-id="d201a-132">Lors de l’hébergement dans un conteneur d’ancrage, les clés doivent être rendues persistantes dans un dossier qui est un volume d’ancrage (un volume partagé ou un volume monté sur l’hôte qui persiste au-delà de la durée de vie du conteneur) ou dans un fournisseur externe, tel que [Azure Key Vault](https://azure.microsoft.com/services/key-vault/) ou des [ReDim](https://redis.io/).</span><span class="sxs-lookup"><span data-stu-id="d201a-132">When hosting in a Docker container, keys should be persisted in a folder that's a Docker volume (a shared volume or a host-mounted volume that persists beyond the container's lifetime) or in an external provider, such as [Azure Key Vault](https://azure.microsoft.com/services/key-vault/) or [Redis](https://redis.io/).</span></span> <span data-ttu-id="d201a-133">Un fournisseur externe est également utile dans les scénarios de batterie de serveurs Web si les applications ne peuvent pas accéder à un volume réseau partagé (pour plus d’informations, consultez [PersistKeysToFileSystem](xref:security/data-protection/configuration/overview#persistkeystofilesystem) ).</span><span class="sxs-lookup"><span data-stu-id="d201a-133">An external provider is also useful in web farm scenarios if apps can't access a shared network volume (see [PersistKeysToFileSystem](xref:security/data-protection/configuration/overview#persistkeystofilesystem) for more information).</span></span>

> [!WARNING]
> <span data-ttu-id="d201a-134">Si le développeur remplace les règles décrites ci-dessus et pointe le système de protection des données dans un référentiel de clé spécifique, le chiffrement automatique des clés au repos est désactivé.</span><span class="sxs-lookup"><span data-stu-id="d201a-134">If the developer overrides the rules outlined above and points the Data Protection system at a specific key repository, automatic encryption of keys at rest is disabled.</span></span> <span data-ttu-id="d201a-135">La protection au repos peut être réactivée via la [configuration](xref:security/data-protection/configuration/overview).</span><span class="sxs-lookup"><span data-stu-id="d201a-135">At-rest protection can be re-enabled via [configuration](xref:security/data-protection/configuration/overview).</span></span>

## <a name="key-lifetime"></a><span data-ttu-id="d201a-136">Durée de vie de la clé</span><span class="sxs-lookup"><span data-stu-id="d201a-136">Key lifetime</span></span>

<span data-ttu-id="d201a-137">Par défaut, les clés ont une durée de vie de 90 jours.</span><span class="sxs-lookup"><span data-stu-id="d201a-137">Keys have a 90-day lifetime by default.</span></span> <span data-ttu-id="d201a-138">Lorsqu’une clé expire, l’application génère automatiquement une nouvelle clé et définit la nouvelle clé comme clé active.</span><span class="sxs-lookup"><span data-stu-id="d201a-138">When a key expires, the app automatically generates a new key and sets the new key as the active key.</span></span> <span data-ttu-id="d201a-139">Tant que les clés retirées restent sur le système, votre application peut déchiffrer toutes les données protégées avec elles.</span><span class="sxs-lookup"><span data-stu-id="d201a-139">As long as retired keys remain on the system, your app can decrypt any data protected with them.</span></span> <span data-ttu-id="d201a-140">Pour plus d’informations, consultez [gestion des clés](xref:security/data-protection/implementation/key-management#key-expiration-and-rolling) .</span><span class="sxs-lookup"><span data-stu-id="d201a-140">See [key management](xref:security/data-protection/implementation/key-management#key-expiration-and-rolling) for more information.</span></span>

## <a name="default-algorithms"></a><span data-ttu-id="d201a-141">Algorithmes par défaut</span><span class="sxs-lookup"><span data-stu-id="d201a-141">Default algorithms</span></span>

<span data-ttu-id="d201a-142">L’algorithme de protection par charge utile par défaut utilisé est AES-256-CBC pour la confidentialité et HMACSHA256 pour l’authenticité.</span><span class="sxs-lookup"><span data-stu-id="d201a-142">The default payload protection algorithm used is AES-256-CBC for confidentiality and HMACSHA256 for authenticity.</span></span> <span data-ttu-id="d201a-143">Une clé principale 512 bits, modifiée tous les 90 jours, est utilisée pour dériver les deux sous-clés utilisées pour ces algorithmes pour chaque charge utile.</span><span class="sxs-lookup"><span data-stu-id="d201a-143">A 512-bit master key, changed every 90 days, is used to derive the two sub-keys used for these algorithms on a per-payload basis.</span></span> <span data-ttu-id="d201a-144">Pour plus d’informations, consultez [dérivation de sous-clés](xref:security/data-protection/implementation/subkeyderivation#additional-authenticated-data-and-subkey-derivation) .</span><span class="sxs-lookup"><span data-stu-id="d201a-144">See [subkey derivation](xref:security/data-protection/implementation/subkeyderivation#additional-authenticated-data-and-subkey-derivation) for more information.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="d201a-145">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="d201a-145">Additional resources</span></span>

* <xref:security/data-protection/extensibility/key-management>
* <xref:host-and-deploy/web-farm>
